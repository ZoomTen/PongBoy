<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Initialization</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave https://github.com/justinmeiners/srcweave -->


<h1>Initialization<a id="c1"></a></h1>


<p>This is the very first thing that&rsquo;s executed once the Game Boy reaches my program, so I&rsquo;ll want to have the Game Boy in a predictable state after booting up. This is done through the initialization process.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="initialization-code-block-75" href="#initialization-code-block-75">Initialization code</a></em></strong></span>
<pre class="prettyprint"><code class="">Init::
<em class="block-link nocode"><a href="#disable-interrupts-block-77">@{Disable interrupts}</a></em>
<em class="block-link nocode"><a href="#save-the-game-boy-type-block-81">@{Save the Game Boy type}</a></em>
<em class="block-link nocode"><a href="#turn-off-the-screen-block-97">@{Turn off the screen}</a></em>
<em class="block-link nocode"><a href="#clear-ram-and-place-the-stack-pointer-block-83">@{Clear RAM and place the stack pointer}</a></em>
<em class="block-link nocode"><a href="#reset-audio-block-105">@{Reset audio}</a></em>
<em class="block-link nocode"><a href="#reset-the-screen-block-99">@{Reset the screen}</a></em>
<em class="block-link nocode"><a href="#copy-hram-dma-code-block-117">@{Copy HRAM DMA code}</a></em>

<em class="block-link nocode"><a href="#set-up-the-game-graphics-block-121">@{Set up the game graphics}</a></em>
<em class="block-link nocode"><a href="#set-up-sprites-and-variables-block-147">@{Set up sprites and variables}</a></em>

<em class="block-link nocode"><a href="#turn-on-screen-block-183">@{Turn on screen}</a></em>
<em class="block-link nocode"><a href="#enable-the-interrupts-again-block-185">@{Enable the interrupts again}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#main-program-block-50" title="Main program. part1.md">1</a> </small></p></div>




<h2>1. First steps<a id="s1:0"></a></h2>


<p>I&rsquo;ll disable interrupts throughout the initialization process to ensure nothing.. er, &ldquo;interrupts&rdquo; me trying to reset the Game Boy state.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="disable-interrupts-block-77" href="#disable-interrupts-block-77">Disable interrupts</a></em></strong></span>
<pre class="prettyprint"><code class="">    di
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<p>Right after the boot ROM hands over control to my program, the A register contains <a href="https://gbdev.io/pandocs/Power_Up_Sequence.html#cpu-registers">different values</a> depending on which Game Boy (or rather, which boot ROM) is used. In case I want to have console-specific features in the future (for example, palettes or extended graphics on Game Boy Color), I&rsquo;ll store this to a variable.</p>

<p>I&rsquo;ll place this variable in HRAM:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hram-definitions-block-79" href="#hram-definitions-block-79">HRAM definitions</a></em></strong></span>
<pre class="prettyprint"><code class="">hGBType:: db
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#-src-include-ram.inc-block-12" title="/src/include/ram.inc. part1.md">1</a> </small></p></div>


<p><code>db</code> is &ldquo;define byte&rdquo;, used here as a shortcut for <code>ds 1</code>. <code>ds</code> itself (as you&rsquo;ll see in a bit) is&mdash;I think&mdash; &ldquo;define space&rdquo;, basically a static allocation of some number of bytes.</p>

<p><aside>
<code>db</code>, when used in ROM, can be used to write raw data. e.g. <code>db 1, 2, $40</code> will write the bytes <code>01 02 40</code> literally into ROM. In RAM, it&rsquo;s equivalent to <code>ds 1</code>.
</aside></p>

<p>And let this be the first thing done:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="save-the-game-boy-type-block-81" href="#save-the-game-boy-type-block-81">Save the Game Boy type</a></em></strong></span>
<pre class="prettyprint"><code class="">    ldh [hGBType], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>




<h2>2. Setting up RAM and stack<a id="s1:1"></a></h2>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="clear-ram-and-place-the-stack-pointer-block-83" href="#clear-ram-and-place-the-stack-pointer-block-83">Clear RAM and place the stack pointer</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#clearing-wram-block-85">@{Clearing WRAM}</a></em>
<em class="block-link nocode"><a href="#set-up-sp-block-91">@{Set up SP}</a></em>
<em class="block-link nocode"><a href="#clearing-hram-block-87">@{Clearing HRAM}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<h3>WRAM</h3>

<p>I&rsquo;ll clear WRAM by setting it to all zeroes.  This uses <a href="part1.html#s0:7">FillMem16</a>, which I defined earlier.</p>

<p>I pointed HL to the start of WRAM, BC to the size of WRAM (simply subtract the start of WRAM from the start of Echo RAM), and A to 0.</p>

<p>Ordinarily <code>ld a, 0</code> can be used to zero out <code>a</code>. But <code>xor a, a</code> (or simply <code>xor a</code>) has the same effect and is faster. It performs an exclusive OR between <code>a</code> and itself, resulting in 0 and stores the result back in <code>a</code>. Since the result is 0, it sets the Z flag&mdash;but I don&rsquo;t care about that right now.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="clearing-wram-block-85" href="#clearing-wram-block-85">Clearing WRAM</a></em></strong></span>
<pre class="prettyprint"><code class="">    xor a
    ld hl, WRAM_START
    ld bc, ECHO_START - WRAM_START
    call FillMem16
</code></pre>
<p class="block-usages"><small>Used by <a href="#clear-ram-and-place-the-stack-pointer-block-83" title="Clear RAM and place the stack pointer">1</a> </small></p></div>


<h3>HRAM</h3>

<p>Next, I clear out HRAM. I&rsquo;ll use <a href="helpers.html#6:2">FillMem8</a> here, since the clearing range is quite small. It&rsquo;s the same as <code>FillMem16</code>, except the range is 8 bits, and set in C. I don&rsquo;t need to set A again, since that remains zero.</p>

<p>I clear out one byte into HRAM, since the first byte is already occupied by the saved GB type.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="clearing-hram-block-87" href="#clearing-hram-block-87">Clearing HRAM</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, hGBType + 1
    ld c, $ffff - (hGBType - 1)
    call FillMem8
</code></pre>
<p class="block-usages"><small>Used by <a href="#clear-ram-and-place-the-stack-pointer-block-83" title="Clear RAM and place the stack pointer">1</a> </small></p></div>


<h3>SP</h3>

<p>SP is the <strong>s</strong>tack <strong>p</strong>ointer. It points to an area in memory where registers are saved to and loaded from as the <code>push</code> and <code>pop</code> instructions are executed. As mentioned previously, it&rsquo;s first-in-last-out, just like a stack of plates. When pushed to, the register is stored where SP is, and SP decrements by two. The opposite happens when popped from: the register is retrieved from where SP was (without clearing it), and SP increments by two.</p>

<p>At boot up, the top of the stack is initialized to <code>$FFFE</code>. With this value, this cuts into HRAM space. I want to set the stack pointer somewhere in WRAM to give it some extra breathing space. <a href="#8.1:2">WRAM clearing</a> uses the stack earlier (<code>call</code> is effectively <code>push pc</code>, conversely, <code>ret</code> being <code>pop pc</code>), which is why I did that first.</p>

<p>I define the reserved space in WRAM:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-89" href="#wram-definitions-block-89">WRAM definitions</a></em></strong></span>
<pre class="prettyprint"><code class="">wStack:: ds $100 - 1
wStackTop:: db
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#-src-include-ram.inc-block-12" title="/src/include/ram.inc. part1.md">1</a> </small></p></div>


<p>Then set it in our init routine:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sp-block-91" href="#set-up-sp-block-91">Set up SP</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld sp, wStackTop
</code></pre>
<p class="block-usages"><small>Used by <a href="#clear-ram-and-place-the-stack-pointer-block-83" title="Clear RAM and place the stack pointer">1</a> </small></p></div>


<p>Now why would the stack be <code>$100</code> bytes long? Admittedly this is quite arbitrary, but there&rsquo;s a possibly good reason which you&rsquo;ll <a href="#8.1:8">see later</a>.</p>

<h2>3. Clearing the screen<a id="s1:2"></a></h2>


<h3>Turning off the screen</h3>

<p>Before I can do anything with the screen, I should disable it to ensure that I&rsquo;m not changing it while it&rsquo;s being accessed. Updating the screen <em>can</em> be done while it&rsquo;s on, but since I&rsquo;m in an init function, it&rsquo;s better to just disable the screen.</p>

<p>I define a helper function <code>DisableLCD</code> here. All it does is wait for the current scanline number to be rendered to be out of bounds (waiting for line 145 to be hit), at which point the Game Boy will enter VBlank. After that, it&rsquo;s safe to disable the LCD controller, which I then do.</p>

<p>This waiting has to be done because disabling the LCD outside of VBlank <a href="https://gbdev.io/pandocs/LCDC.html#lcdc7--lcd-enable">may damage real hardware</a>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="disablelcd-block-93" href="#disablelcd-block-93">DisableLCD</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Turns off the screen
;;
;; @return [rLCDC] ~= LCD_ENABLE_BIT
;;--
DisableLCD::
.wait
    ld a, [rLY]
    cp LY_VBLANK
    jr nc, .disable ; &gt;= LY_VBLANK? jump if yes
    jr .wait        ; otherwise keep waiting
.disable
    ld a, [rLCDC]
    res LCD_ENABLE_BIT, a ; disable LCD
    ld [rLCDC], a
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-95" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-95" href="#helper-functions-block-95">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#disablelcd-block-93">@{DisableLCD}</a></em>
</code></pre>
</div>


<p>I then call it from the initialization routine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="turn-off-the-screen-block-97" href="#turn-off-the-screen-block-97">Turn off the screen</a></em></strong></span>
<pre class="prettyprint"><code class="">    call DisableLCD
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<h3>Reset the screen</h3>

<p>I clear the entirety of VRAM and reset every scroll register. At this point, A = 0.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-screen-block-99" href="#reset-the-screen-block-99">Reset the screen</a></em></strong></span>
<pre class="prettyprint"><code class="">; zero out VRAM
    ld hl, VRAM_START
    ld bc, SRAM_START - VRAM_START
    call FillMem16

; reset scroll registers
    ldh [rSCX], a
    ldh [rSCY], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<p>I scroll the window down off-screen initially.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-screen-block-101" href="#reset-the-screen-block-101">Reset the screen</a></em></strong> <a href="#reset-the-screen-block-99">+=</a></span>
<pre class="prettyprint"><code class="">; scroll the window register out
    ld a, LY_VBLANK
    ldh [rWY], a
    ld a, 7
    ldh [rWX], a
</code></pre>
</div>


<p>And I reset all <a href="https://gbdev.io/pandocs/Palettes.html#ff47--bgp-non-cgb-mode-only-bg-palette-data">monochrome palettes</a> used by the Game Boy. The Game Boy follows a sort of reverse-format for palettes, and is an 8-bit value with the shades being 2 bits each. The normal palette as defined in binary is <code>11 10 01 00</code> (black, dark gray, light gray, white), which I&rsquo;ll use to set all 3 palettes used by the Game Boy.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-screen-block-103" href="#reset-the-screen-block-103">Reset the screen</a></em></strong> <a href="#reset-the-screen-block-99">+=</a></span>
<pre class="prettyprint"><code class="">    ld a, %11100100
    ldh [rBGP], a  ; background
    ldh [rOBP0], a ; object palette 0
    ldh [rOBP1], a ; object palette 1
</code></pre>
</div>




<h2>4. Reset audio<a id="s1:3"></a></h2>


<p>I&rsquo;ll kill the audio circuitry by zeroing out <code>NR52</code>. This has the <a href="https://gbdev.io/pandocs/Audio_Registers.html#ff26--nr52-sound-onoff">bonus effect</a> of <em>also</em> zeroing out all the audio registers. A is still 0 at this point.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-audio-block-105" href="#reset-audio-block-105">Reset audio</a></em></strong></span>
<pre class="prettyprint"><code class="">    ldh [rNR52], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>




<h2>5. Copy DMA code<a id="s1:4"></a></h2>


<p>This is needed for manipulating sprites, since it&rsquo;s not possible to manipulate OAM directly. Instead, let the Game Boy itself do it though a DMA transfer from RAM to OAM. During this time, the CPU cannot access anything other than HRAM, so to ensure the CPU can go back to the ROM safely, I need to place this code <em>inside</em> HRAM, and run it from there.</p>

<p>This also means that I need to make room for a &ldquo;virtual OAM&rdquo; inside of WRAM. This is what I&rsquo;ll update from within the program, instead of using the OAM memory region directly.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-107" href="#wram-definitions-block-107">WRAM definitions</a></em></strong> <a href="#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">wVirtualOAM:: ds 4*MAX_SPRITES
</code></pre>
</div>


<p><aside>
Compiler quirks mean there&rsquo;s to be no spaces between operands here, while they seem to be accepted inside of instructions. It&rsquo;s weird, I know.
</aside></p>

<p>Let&rsquo;s define <code>MAX_SPRITES</code> to make the code a bit more obvious:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-src-include-constants.inc-block-109" href="#-src-include-constants.inc-block-109">/src/include/constants.inc</a></em></strong> <a href="part1.html#-src-include-constants.inc-block-6">+=</a></span>
<pre class="prettyprint"><code class="">MAX_SPRITES equ 40
</code></pre>
</div>


<p>With that, I can write the code that needs to be copied. Note that all this code does is wait until the DMA finishes doing its thing.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="dmaroutine-block-111" href="#dmaroutine-block-111">DMARoutine</a></em></strong></span>
<pre class="prettyprint"><code class="">DMARoutine::
    ld a, wVirtualOAM // $1000000 ; HIGH(wVirtualOAM)
    ldh [rDMA], a
    ld a, MAX_SPRITES ; wait 4 * MAX_SPRITES cycles 
.loop
    dec a        ; 1 cycle
    jr nz, .loop ; 3 cycles
    ret
DMARoutine_END::
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-113" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-113" href="#helper-functions-block-113">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#dmaroutine-block-111">@{DMARoutine}</a></em>
</code></pre>
</div>


<p><aside>
Yeah&hellip; <code>wVirtualOAM // $1000000</code>? My fault for using ASMotor, I guess lol. (That, or there&rsquo;s a better way that I&rsquo;ve not yet discovered.)
</aside></p>

<p>I reserve some space in HRAM for the code:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hram-definitions-block-115" href="#hram-definitions-block-115">HRAM definitions</a></em></strong> <a href="#hram-definitions-block-79">+=</a></span>
<pre class="prettyprint"><code class="">hDMACode:: ds 10
</code></pre>
</div>


<p>Then the DMA code is copied there. This time, I&rsquo;m not using the helper functions, since I want to make use of this particular instruction: <code>ld [$ff00+c], a</code>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copy-hram-dma-code-block-117" href="#copy-hram-dma-code-block-117">Copy HRAM DMA code</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, DMARoutine
    ld b, DMARoutine_END - DMARoutine
    ld c, hDMACode ~/ $ff ; LOW(hDMACode)
.copy_code
    ld a, [hl+]
    ld [$ff00+c], a
    inc c
    dec b
    jr nz, .copy_code
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<p>Because of the nature of <code>rDMA</code>, I have to ensure that <code>wVirtualOAM</code>&rsquo;s <em>location</em> is a multiple of <code>$100</code>. <code>wStack</code> (<a href="#8.1:3">as you saw earlier</a>) comes before it, and the rather arbitrary size of <code>$100</code> happens to fit nicely with this requirement.</p>

<p>Now where would this code be run&hellip; how about once every frame? I can use the VBlank interrupt to call the code from the allocated space in HRAM:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="contents-of-vblank-block-119" href="#contents-of-vblank-block-119">Contents of VBlank</a></em></strong></span>
<pre class="prettyprint"><code class="">    call hDMACode
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#vblank-interrupt-routine-block-64" title="VBlank interrupt routine. part1.md">1</a> </small></p></div>




<h2>6. Set up the game graphics<a id="s1:5"></a></h2>


<p>Next up, I&rsquo;ll copy the graphics to VRAM, starting with the actual tiles, and then setting up the background.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-the-game-graphics-block-121" href="#set-up-the-game-graphics-block-121">Set up the game graphics</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#copy-over-the-main-tileset-block-125">@{Copy over the main tileset}</a></em>
<em class="block-link nocode"><a href="#copy-over-the-score-numeral-tileset-block-129">@{Copy over the score numeral tileset}</a></em>
<em class="block-link nocode"><a href="#copy-over-the-background-tile-map-block-137">@{Copy over the background tile map}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#gm_game-init-code-block-385" title="GM_Game init code. part4.md">2</a> <a href="part4.html#gm_game-init-code-block-449" title="GM_Game init code. part4.md">3</a> </small></p></div>


<h3>Load main tileset</h3>

<p>The main tileset in use is, well, plain Pong graphics. For this game I&rsquo;m going with a sort of 3D type look. These graphics will be used for the objects as well as the background.</p>

<p><figure>
<img class="pixelated" alt="Game graphics" src="../src/gfx/game.png">
<figcaption>Game graphics</figcaption>
</figure></p>

<p>I&rsquo;ll include the data here. The .2bpp file will be automatically generated from the .png file when built.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="miscellaneous-data-block-123" href="#miscellaneous-data-block-123">Miscellaneous data</a></em></strong></span>
<pre class="prettyprint"><code class="">PongGFX::
    incbin "gfx/game.2bpp"
PongGFX_END::
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#-src-pong.asm-block-2" title="/src/pong.asm. part1.md">1</a> </small></p></div>


<p>(Also notice the use of <code>incbin</code> instead of <code>include</code>. As it says, it inserts a binary file straight into the ROM, instead of trying to compile the file as source code&mdash;which is what <code>include</code> does.)</p>

<p>And then load it into VRAM&mdash;specifically, the first tileset slot&mdash;with the <a href="helpers.html#6:5">CopyMem16</a> helper function. At this point, the screen is still off, so I&rsquo;m safe to do it like a regular memory copy.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copy-over-the-main-tileset-block-125" href="#copy-over-the-main-tileset-block-125">Copy over the main tileset</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, vChars0
    ld de, PongGFX
    ld bc, PongGFX_END - PongGFX
    call CopyMem16
</code></pre>
<p class="block-usages"><small>Used by <a href="#set-up-the-game-graphics-block-121" title="Set up the game graphics">1</a> </small></p></div>


<h3>Loading numerals</h3>

<p>Then, these numerals, which will be used for the score display. They&rsquo;re 8x16 blocks with the upper half stored first and then the lower half. They&rsquo;ll be used to print the score to the background.</p>

<p><figure>
<img class="pixelated" alt="Score numerals" src="../src/gfx/numbers.png">
<figcaption>Score numerals</figcaption>
</figure></p>

<p>I&rsquo;ll include it just like the Pong graphics:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="miscellaneous-data-block-127" href="#miscellaneous-data-block-127">Miscellaneous data</a></em></strong> <a href="#miscellaneous-data-block-123">+=</a></span>
<pre class="prettyprint"><code class="">NumbersGFX::
    incbin "gfx/numbers.2bpp"
NumbersGFX_END::
</code></pre>
</div>


<p>And then load them up similarly, only such that it starts at tile $10.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copy-over-the-score-numeral-tileset-block-129" href="#copy-over-the-score-numeral-tileset-block-129">Copy over the score numeral tileset</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, vChars0 + $100
    ld de, NumbersGFX
    ld bc, NumbersGFX_END - NumbersGFX
    call CopyMem16
</code></pre>
<p class="block-usages"><small>Used by <a href="#set-up-the-game-graphics-block-121" title="Set up the game graphics">1</a> </small></p></div>


<p>There&rsquo;s a little compiler trick i can use here. Instead of <code>$100</code>, I can just say how many tiles to offset it with. To do that, I first define this:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-131" href="#constants-block-131">Constants</a></em></strong></span>
<pre class="prettyprint"><code class="">tiles equs "* $10"
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#-src-include-constants.inc-block-8" title="/src/include/constants.inc. part1.md">1</a> </small></p></div>


<p>What this does is make it so that the statement <code>6 tiles</code> in the code turns into <code>6 * $10</code>. The <code>$10</code> is how big one tile&rsquo;s worth of graphics are in VRAM.</p>

<p>So now, I can write this instead:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copy-over-the-score-numeral-tileset-block-133" href="#copy-over-the-score-numeral-tileset-block-133">Copy over the score numeral tileset</a></em></strong> <a href="#copy-over-the-score-numeral-tileset-block-129">:=</a></span>
<pre class="prettyprint"><code class="">    ld hl, vChars0 + $10 tiles
    ld de, NumbersGFX
    ld bc, NumbersGFX_END - NumbersGFX
    call CopyMem16
</code></pre>
</div>


<h3>Load the background</h3>

<p>The background will use the main tileset, so I&rsquo;ll incbin the tile map.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="miscellaneous-data-block-135" href="#miscellaneous-data-block-135">Miscellaneous data</a></em></strong> <a href="#miscellaneous-data-block-123">+=</a></span>
<pre class="prettyprint"><code class="">BackgroundMAP::
    incbin "gfx/background.map"
BackgroundMAP_END::
</code></pre>
</div>


<p>I&rsquo;m not doing anything fancy (or optimized) here, it&rsquo;s just a straight-up copy to the first background map slot.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copy-over-the-background-tile-map-block-137" href="#copy-over-the-background-tile-map-block-137">Copy over the background tile map</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, vBGMap0
    ld de, BackgroundMAP
    ld bc, BackgroundMAP_END - BackgroundMAP
    call CopyMem16
</code></pre>
<p class="block-usages"><small>Used by <a href="#set-up-the-game-graphics-block-121" title="Set up the game graphics">1</a> </small></p></div>


<h3>A look at VRAM</h3>

<p>After this is done, here&rsquo;s what the tileset in VRAM will look like:</p>

<p><figure>
<img src="../figures/vram1.svg">
</figure></p>

<p>The Pong graphics start at tile <code>$00</code> through <code>$09</code>, while the numerals start at <code>$10</code>, being split as the upper half (<code>$10</code>&ndash;<code>$19</code>) and the lower half (<code>$1A</code>&ndash;<code>$22</code>)</p>

<h2>7. Initializing variables<a id="s1:6"></a></h2>


<p>I&rsquo;ll define the variables that I think a typical Pong game can have. Here I assume that the paddles will not be able to move left and right&mdash;only up and down. So I&rsquo;ll store only the Y position of both paddles.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-139" href="#wram-definitions-block-139">WRAM definitions</a></em></strong> <a href="#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">; paddle position
wLeftPaddleY:: db
wRightPaddleY:: db
</code></pre>
</div>


<p>Every Pong clone since about 1975 has got to have its own scorekeeping system, so I&rsquo;ll prepare those, too.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-141" href="#wram-definitions-block-141">WRAM definitions</a></em></strong> <a href="#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">; score
wLeftScore:: db
wRightScore:: db
</code></pre>
</div>


<p>Then the position of the ball, for the physics and stuff.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-143" href="#wram-definitions-block-143">WRAM definitions</a></em></strong> <a href="#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">; ball position
wBallX:: db
wBallY:: db
</code></pre>
</div>


<p>And then I&rsquo;ll fill all of them in&hellip; except the score, obviously. The paddles will have the same starting position, so I can use one constant for both.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-145" href="#constants-block-145">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">PADDLES_STARTING_Y equ $40
BALL_STARTING_X equ $54
BALL_STARTING_Y equ $50
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sprites-and-variables-block-147" href="#set-up-sprites-and-variables-block-147">Set up sprites and variables</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, PADDLES_STARTING_Y
    ld [wLeftPaddleY], a
    ld [wRightPaddleY], a
    
    ld a, BALL_STARTING_X
    ld [wBallX], a
    
    ld a, BALL_STARTING_Y
    ld [wBallY], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#gm_game-init-code-block-385" title="GM_Game init code. part4.md">2</a> <a href="part4.html#gm_game-init-code-block-449" title="GM_Game init code. part4.md">3</a> </small></p></div>


<p>Next I&rsquo;ll place the objects on the screen, which I&rsquo;ll get to shortly.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sprites-and-variables-block-149" href="#set-up-sprites-and-variables-block-149">Set up sprites and variables</a></em></strong> <a href="#set-up-sprites-and-variables-block-147">+=</a></span>
<pre class="prettyprint"><code class="">    call SetupLeftPaddle
    call SetupRightPaddle
    call SetupBall
</code></pre>
</div>




<h2>8. Setting up sprites<a id="s1:7"></a></h2>


<p>I&rsquo;m using a fixed allocation system for my sprites: 5 sprites each for the paddles and 1 sprite for the ball. So 11 sprites in total, all of them 8&times;8 sprites. Here&rsquo;s how it&rsquo;ll be laid out:</p>

<p><figure>
<img src="../figures/vram2.svg">
</figure></p>

<p>Given a starting Y position, the individual paddle sprites will be offset to the bottom by 8 pixels each (from the sprite above it) so as to form the complete paddle, while the ball stands on its own and can be moved freely.</p>

<h3>Initializing the left paddle</h3>

<p>To make things a little easier, let&rsquo;s have a shortcut to add sprites. It just places whatever is in A, B, C, D to the address pointed to by HL.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="addsprite-block-151" href="#addsprite-block-151">AddSprite</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Uses A, B, C, D to write to OAM.
;; 
;; @param HL   sprite starting position
;; @param A    sprite's Y position
;; @param B    sprite's X position
;; @param C    sprite's tile
;; @param D    sprite's flags
;;--
AddSprite::
    ld [hl+], a
    ld [hl], b
    inc hl
    ld [hl], c
    inc hl
    ld [hl], d
    inc hl
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-177" title="Helper functions">1</a> </small></p></div>


<p>First up, something to put the left paddle sprite on screen. The left paddle will occupy sprite slots 0&ndash;4, so its starting slot is 0.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-153" href="#constants-block-153">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">SPRITE_SLOT_LEFT_PADDLE equ 0
</code></pre>
</div>


<p>I want some space between the left side of the screen and the left paddle, just to make things nicer to look at. So here&rsquo;s the starting X position.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-155" href="#constants-block-155">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">LEFT_PADDLE_X equ 16
</code></pre>
</div>


<p>The compiler trick explained previously, but this time I&rsquo;m using it to say which sprite slot I want to start in.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-157" href="#constants-block-157">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">sprite equs "+ 4*"
</code></pre>
</div>


<p>You can see it in action here, where <code>wVirtualOAM sprite SPRITE_SLOT_LEFT_PADDLE</code> really just compiles to <code>wVirtualOAM + 4*0</code>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setupleftpaddle-block-159" href="#setupleftpaddle-block-159">SetupLeftPaddle</a></em></strong></span>
<pre class="prettyprint"><code class="">SetupLeftPaddle::
    ld hl, wVirtualOAM sprite SPRITE_SLOT_LEFT_PADDLE
    ld d, 0  ; flags
    ld b, LEFT_PADDLE_X  ; X position
    ld c, 8  ; tile (top of paddle)
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-177" title="Helper functions">1</a> </small></p></div>


<p>As established earlier, I can&rsquo;t put sprites directly into OAM memory, which is why <code>wVirtualOAM</code> is used instead.</p>

<p>I&rsquo;ll set up the first sprite of the paddle&hellip;</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setupleftpaddle-block-161" href="#setupleftpaddle-block-161">SetupLeftPaddle</a></em></strong> <a href="#setupleftpaddle-block-159">+=</a></span>
<pre class="prettyprint"><code class="">; first sprite
    ld a, [wLeftPaddleY]
    call AddSprite
</code></pre>
</div>


<p>Then the next sprites will be added downwards of 8 pixels at a time.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setupleftpaddle-block-163" href="#setupleftpaddle-block-163">SetupLeftPaddle</a></em></strong> <a href="#setupleftpaddle-block-159">+=</a></span>
<pre class="prettyprint"><code class="">; second sprite
    ld c, 1  ; set tile to the mid-paddle one
    add a, 8
    call AddSprite

; third sprite
    add a, 8
    call AddSprite

; fourth sprite
    add a, 8
    call AddSprite

; final sprite
    ld c, 9  ; bottom of paddle
    add a, 8
</code></pre>
</div>


<p>Finally, I use <code>jp</code> here. It&rsquo;s better to use it than having a <code>call</code> then a <code>ret</code>, since this is a subroutine called from somewhere else.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setupleftpaddle-block-165" href="#setupleftpaddle-block-165">SetupLeftPaddle</a></em></strong> <a href="#setupleftpaddle-block-159">+=</a></span>
<pre class="prettyprint"><code class="">; fall through
    jp AddSprite
</code></pre>
</div>


<h3>Initializing the right paddle</h3>

<p>Same as before, but the right paddle will occupy sprite slots 5&ndash;9.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-167" href="#constants-block-167">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">SPRITE_SLOT_RIGHT_PADDLE equ 5
</code></pre>
</div>


<p>I&rsquo;ll set this to 8 pixels away from the right edge of the screen.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-169" href="#constants-block-169">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">RIGHT_PADDLE_X equ 160-8
</code></pre>
</div>


<p>And then the similar-looking code.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setuprightpaddle-block-171" href="#setuprightpaddle-block-171">SetupRightPaddle</a></em></strong></span>
<pre class="prettyprint"><code class="">SetupRightPaddle::
    ld hl, wVirtualOAM sprite SPRITE_SLOT_RIGHT_PADDLE
    ld d, 0  ; flags
    ld b, RIGHT_PADDLE_X  ; X position
    ld c, 8  ; tile
; first sprite
    ld a, [wRightPaddleY]
    call AddSprite
; second sprite
    ld c, 1
    add a, 8
    call AddSprite
; third sprite
    add a, 8
    call AddSprite
; fourth sprite
    add a, 8
    call AddSprite
; fifth sprite
    ld c, 9
    add a, 8
; fall through
    jp AddSprite
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-177" title="Helper functions">1</a> </small></p></div>


<h3>Initializing the ball</h3>

<p>The ball will occupy sprite slot 10. Since the ball is only one sprite, this is a simpler subroutine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-173" href="#constants-block-173">Constants</a></em></strong> <a href="#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">SPRITE_SLOT_BALL equ 10
</code></pre>
</div>


<p>Basically just a call to AddSprite, nothing more.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="setupball-block-175" href="#setupball-block-175">SetupBall</a></em></strong></span>
<pre class="prettyprint"><code class="">SetupBall::
    ld hl, wVirtualOAM sprite SPRITE_SLOT_BALL
    ld a, [wBallX]
    ld b, a
    ld a, [wBallY]
    ld c, 2
    ld d, 0
    jp AddSprite
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-177" title="Helper functions">1</a> </small></p></div>


<h3>Add functions to ROM</h3>

<p>Let&rsquo;s add the helpers I defined here&hellip;</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-177" href="#helper-functions-block-177">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#addsprite-block-151">@{AddSprite}</a></em>
<em class="block-link nocode"><a href="#setupleftpaddle-block-159">@{SetupLeftPaddle}</a></em>
<em class="block-link nocode"><a href="#setuprightpaddle-block-171">@{SetupRightPaddle}</a></em>
<em class="block-link nocode"><a href="#setupball-block-175">@{SetupBall}</a></em>
</code></pre>
</div>




<h2>9. Finishing up initialization<a id="s1:8"></a></h2>


<h3>Turning on the screen</h3>

<p>Finally, I&rsquo;ll turn on the screen, since I&rsquo;m just about done loading everything. I&rsquo;ll define <code>EnableLCD</code> to have a sort of &ldquo;preset&rdquo; for the entire game.</p>

<p>I chose to have the tileset at <code>$8000</code> and the tilemap at <code>$9800</code>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="enablelcd-block-179" href="#enablelcd-block-179">EnableLCD</a></em></strong></span>
<pre class="prettyprint"><code class="">EnableLCD::
    ld a, LCD_ENABLE | LCD_SET_8000 | LCD_MAP_9800 | LCD_OBJ_NORM | LCD_OBJ_ENABLE | LCD_BG_ENABLE
    ldh [rLCDC], a
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-181" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-181" href="#helper-functions-block-181">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#enablelcd-block-179">@{EnableLCD}</a></em>
</code></pre>
</div>


<p>Then it&rsquo;s one <code>call</code> away.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="turn-on-screen-block-183" href="#turn-on-screen-block-183">Turn on screen</a></em></strong></span>
<pre class="prettyprint"><code class="">    call EnableLCD
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>


<h3>Enabling interrupts</h3>

<p>Here I enable interrupts, but choosing specifically which interrupt to enable. In this case, only the VBlank interrupt.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="enable-the-interrupts-again-block-185" href="#enable-the-interrupts-again-block-185">Enable the interrupts again</a></em></strong></span>
<pre class="prettyprint"><code class="">; set the interrupt to enable
    ld a, 1 &lt;&lt; VBLANK
    ldh [rIE], a

; enable them
    ei
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-75" title="Initialization code">1</a> <a href="part4.html#initialization-code-block-397" title="Initialization code. part4.md">2</a> </small></p></div>

</body>
</html>
