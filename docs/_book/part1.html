<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Introduction and setup</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave https://github.com/justinmeiners/srcweave -->


<h1>Introduction and setup<a id="c0"></a></h1>




<h2>1. Some prerequisites<a id="s0:0"></a></h2>


<p>In order to build this game, I assume you have the following (A Unix-like shell is preferred):</p>

<ul>
<li><a href="https://www.gnu.org/software/make/">GNU Make</a></li>
<li><a href="https://github.com/asmotor/asmotor">ASMotor</a></li>
<li><a href="https://github.com/Optiroc/SuperFamiconv">SuperFamiConv</a></li>
</ul>


<p>All of those should be accessible from your terminal, they are required to build the source code that&rsquo;s being explained here.</p>

<p>The source code (and ROM) can be obtained as a <a href="pong-src.zip">zip file</a>, for convenience.</p>

<h3>Assumptions</h3>

<p>Since these are what the assembler uses:
- Hexadecimal numbers are prefixed with <code>$</code>, e.g. <code>$7f</code>.
- Binary numbers are prefixed with <code>%</code>, e.g. <code>%1010</code>.</p>

<p>The terms &ldquo;game&rdquo; and &ldquo;program&rdquo; will probably be used interchangeably. Likewise between the terms &ldquo;function&rdquo;, &ldquo;routine&rdquo;, and &ldquo;subroutine&rdquo;.</p>

<p>&ldquo;Sections&rdquo; are used to organize the program. The linker uses these as a guide to place code and data. I can use this to specify manually that a piece of code should reside in a specific bank (or a location), but for this write-up I decided to place everything in bank 0, also known as the home bank (because it&rsquo;s always accessible by the Game Boy).</p>

<p>I&rsquo;ll refer registers (8-bit and 16-bit) in uppercase, e.g. A, B, C, HL, DE, etc.</p>

<pre>
; place everything below the section line at bank 0 ("home").
    section "code", HOME
</pre>


<p>Labels are suffixed with <code>::</code> so that they may be exported automatically. It&rsquo;s probably a quirk of the assembler, but unless labels are exported, I find that they won&rsquo;t appear in the .map file (which is readable as a .sym file by emulators like BGB and Emulicious, useful for debugging).</p>

<p>The syntax highlighting in this write-up won&rsquo;t be helpful, and I don&rsquo;t feel like hacking the script further to include a syntax highlighter for Game Boy ASM&hellip; colors are pretty though.</p>

<h2>2. Code layout<a id="s0:1"></a></h2>


<h3>Files and directories</h3>

<p>My source code layout is quite minimal for this tutorial (<code>./</code> is the source directory):</p>

<ul>
<li><code>./pong.asm</code> - All the game logic resides in this file.</li>
<li><code>./include/*</code> - Anything that can be included from <code>pong.asm</code>.</li>
<li><code>./gfx/*</code> - Graphics data, including generated files.</li>
<li>No dedicated object file folder or generated ROM folder is considered for now.</li>
</ul>


<p>For the exact steps being taken to build the ROM, see <a href="part6.html#s6:0">the Makefile</a>.</p>

<h3>ROM code</h3>

<p>Now I&rsquo;ll start writing <code>pong.asm</code>. First, I&rsquo;ll want to define the constants, macros, and variables (allocated to memory) since the source is read from top to bottom. I&rsquo;ll reserve these sections and then add to them as I go.</p>

<p>The first $4000 bytes of the Game Boy ROM are mapped, appropriately, to the first $4000 bytes of the Game Boy&rsquo;s memory. If you take a look at <a href="https://gbdev.io/pandocs/Memory_Map.html#jump-vectors-in-first-rom-bank">the memory map</a>, early on you&rsquo;ll find what&rsquo;s called &ldquo;jump vectors&rdquo;. In short, they&rsquo;re basically what is called by an <code>rst</code> instruction, as well as any interrupt, should they be enabled. Because they&rsquo;re placed as the first thing in memory, I have to place these at the start of the ROM as well.</p>

<p>After the jump vectors, there&rsquo;s a bit of unused space up to <code>$00FF</code> that I may use for other purpose as I see fit. Let&rsquo;s call this &ldquo;high HOME&rdquo; since it&rsquo;s a small area of the HOME bank before the header. For now, I&rsquo;ll leave this unused by placing nothing in it.  Following <em>that</em> is the entry point, cartridge header, the main program, and finally anything else the game might require (such as graphics).</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-src-pong.asm-block-2" href="#-src-pong.asm-block-2">/src/pong.asm</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#constants-includes-block-4">@{Constants includes}</a></em>
<em class="block-link nocode"><a href="#memory-definitions-block-10">@{Memory definitions}</a></em>
<em class="block-link nocode"><a href="#jump-vectors-block-14">@{Jump vectors}</a></em>

    section "high_home", HOME[$68]
; not used
    
    section "entry", HOME[$100]
<em class="block-link nocode"><a href="#entry-point-block-46">@{Entry point}</a></em>

    section "header", HOME[$134]
<em class="block-link nocode"><a href="#header-block-48">@{Header}</a></em>

    section "program", HOME[$150]
<em class="block-link nocode"><a href="#main-program-block-50">@{Main program}</a></em>

    section "data", DATA
<em class="block-link nocode" title="part2.md"><a href="part2.html#miscellaneous-data-block-123">@{Miscellaneous data}</a></em>
</code></pre>
</div>




<h2>3. Setup constants and variables<a id="s0:2"></a></h2>


<p>I&rsquo;ll start by defining some basic constants here. I first include the <a href="part6.html#s6:1">hardware constants file</a>, and then my custom constants.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-includes-block-4" href="#constants-includes-block-4">Constants includes</a></em></strong></span>
<pre class="prettyprint"><code class="">    include "include/hardware.inc"
    include "include/constants.inc"
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>


<p>The compiler will replace these lines with the actual contents of whatever file I&rsquo;m including as if it&rsquo;s part of the main source code, so that they will get compiled with the rest of the code.
</aside></p>

<h3>Basic constants</h3>

<p>For now, I&rsquo;ll just place the start of some significant memory addresses in my <code>constants.inc</code>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-src-include-constants.inc-block-6" href="#-src-include-constants.inc-block-6">/src/include/constants.inc</a></em></strong></span>
<pre class="prettyprint"><code class="">VRAM_START equ $8000
SRAM_START equ $a000
WRAM_START equ $c000
ECHO_START equ $e000
HRAM_START equ $ff80
</code></pre>
</div>


<p><code>VRAM_START equ $8000</code> makes it so I can just type in <code>VRAM_START</code> instead of the literal number <code>$8000</code> every time I want to use it in code. This makes the code a bit more readable and also if I ever need to change it, this can be the only place to do so (and then it&rsquo;s reflected on the entire program)</p>

<h3>Game constants</h3>

<p>Next up, constants used by the game. I can fill this out later.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-src-include-constants.inc-block-8" href="#-src-include-constants.inc-block-8">/src/include/constants.inc</a></em></strong> <a href="#-src-include-constants.inc-block-6">+=</a></span>
<pre class="prettyprint"><code class="">; Game constants
<em class="block-link nocode" title="part2.md"><a href="part2.html#constants-block-131">@{Constants}</a></em>
</code></pre>
</div>




<h2>4. Memory definitions<a id="s0:3"></a></h2>


<p>The memory definitions will be in yet another separate include file.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="memory-definitions-block-10" href="#memory-definitions-block-10">Memory definitions</a></em></strong></span>
<pre class="prettyprint"><code class="">    include "include/ram.inc"
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>


<p>I&rsquo;ll define variables to put in both WRAM and HRAM here.</p>

<p>WRAM (&ldquo;work RAM&rdquo;) is the 8K section of memory where most of the game-related variables live. It starts at address <code>$C000</code> in the Game Boy&rsquo;s memory, so that&rsquo;s where I&rsquo;ll specify where it begins.</p>

<p>(<code>BSS</code> here is the predefined section type for a memory allocation)</p>

<p>HRAM (&ldquo;high RAM&rdquo;) is limited to 127 bytes, and is where I&rsquo;ll put any variables that need to be accessed quickly. It starts at <code>$FF80</code> in the Game Boy&rsquo;s memory.</p>

<p>There are instructions specifically for manipulating the memory between <code>$FF00</code> and <code>$FFFF</code>, and these take less space and cycles than if we were to use the regular equivalents&mdash;thus there&rsquo;s an opportunity for optimization there.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="-src-include-ram.inc-block-12" href="#-src-include-ram.inc-block-12">/src/include/ram.inc</a></em></strong></span>
<pre class="prettyprint"><code class="">    section "wram", BSS[$c000]
<em class="block-link nocode" title="part2.md"><a href="part2.html#wram-definitions-block-89">@{WRAM definitions}</a></em>

    section "hram", HRAM
<em class="block-link nocode" title="part2.md"><a href="part2.html#hram-definitions-block-79">@{HRAM definitions}</a></em>
</code></pre>
</div>




<h2>5. Hardware jump vectors<a id="s0:4"></a></h2>


<p>As is explained before, the jump vectors consist of <code>rst</code> jump vectors and interrupt jump vectors:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="jump-vectors-block-14" href="#jump-vectors-block-14">Jump vectors</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#rst-vectors-block-16">@{Rst vectors}</a></em>
<em class="block-link nocode"><a href="#interrupt-vectors-block-34">@{Interrupt vectors}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>


<h3>Rst jump points</h3>

<p>First, the jump points for the <code>rst</code> instructions.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst-vectors-block-16" href="#rst-vectors-block-16">Rst vectors</a></em></strong></span>
<pre class="prettyprint"><code class="">    section "rst00", HOME[0]
    <em class="block-link nocode"><a href="#rst00-vector-block-18">@{Rst00 vector}</a></em>
    
    section "rst08", HOME[8]
    <em class="block-link nocode"><a href="#rst08-vector-block-20">@{Rst08 vector}</a></em>
    
    section "rst10", HOME[$10]
    <em class="block-link nocode"><a href="#rst10-vector-block-22">@{Rst10 vector}</a></em>
    
    section "rst18", HOME[$18]
    <em class="block-link nocode"><a href="#rst18-vector-block-24">@{Rst18 vector}</a></em>
    
    section "rst20", HOME[$20]
    <em class="block-link nocode"><a href="#rst20-vector-block-26">@{Rst20 vector}</a></em>
    
    section "rst28", HOME[$28]
    <em class="block-link nocode"><a href="#rst28-vector-block-28">@{Rst28 vector}</a></em>
    
    section "rst30", HOME[$30]
    <em class="block-link nocode"><a href="#rst30-vector-block-30">@{Rst30 vector}</a></em>
    
    section "rst38", HOME[$38]
    <em class="block-link nocode"><a href="#rst38-vector-block-32">@{Rst38 vector}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#jump-vectors-block-14" title="Jump vectors">1</a> </small></p></div>


<p>For now, I&rsquo;ll leave them unused.</p>

<p>When the <code>rst</code> instruction is invoked, it&rsquo;ll actually do a <code>call</code>, so I&rsquo;ll place a <code>ret</code> instruction on these to make it immediately go back to wherever it&rsquo;s called from.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst00-vector-block-18" href="#rst00-vector-block-18">Rst00 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst08-vector-block-20" href="#rst08-vector-block-20">Rst08 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst10-vector-block-22" href="#rst10-vector-block-22">Rst10 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst18-vector-block-24" href="#rst18-vector-block-24">Rst18 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst20-vector-block-26" href="#rst20-vector-block-26">Rst20 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst28-vector-block-28" href="#rst28-vector-block-28">Rst28 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst30-vector-block-30" href="#rst30-vector-block-30">Rst30 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="rst38-vector-block-32" href="#rst38-vector-block-32">Rst38 vector</a></em></strong></span>
<pre class="prettyprint"><code class="">ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#rst-vectors-block-16" title="Rst vectors">1</a> </small></p></div>


<h3>Interrupt jump routines</h3>

<p>Then, the interrupt vectors.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="interrupt-vectors-block-34" href="#interrupt-vectors-block-34">Interrupt vectors</a></em></strong></span>
<pre class="prettyprint"><code class="">    section "int_vblank", HOME[$40]
    <em class="block-link nocode"><a href="#vblank-interrupt-vector-block-36">@{VBlank interrupt vector}</a></em>
    
    section "int_hblank", HOME[$48]
    <em class="block-link nocode"><a href="#hblank-interrupt-vector-block-38">@{HBlank interrupt vector}</a></em>
    
    section "int_timer", HOME[$50]
    <em class="block-link nocode"><a href="#timer-interrupt-vector-block-40">@{Timer interrupt vector}</a></em>
    
    section "int_serial", HOME[$58]
    <em class="block-link nocode"><a href="#serial-interrupt-vector-block-42">@{Serial interrupt vector}</a></em>
    
    section "int_joypad", HOME[$60]
    <em class="block-link nocode"><a href="#joypad-interrupt-vector-block-44">@{Joypad interrupt vector}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#jump-vectors-block-14" title="Jump vectors">1</a> </small></p></div>


<p>I&rsquo;ll blank these out for now, as well. This time, I use <code>reti</code> to acknowledge that I&rsquo;m returning from an interrupt call.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="vblank-interrupt-vector-block-36" href="#vblank-interrupt-vector-block-36">VBlank interrupt vector</a></em></strong></span>
<pre class="prettyprint"><code class="">reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#interrupt-vectors-block-34" title="Interrupt vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hblank-interrupt-vector-block-38" href="#hblank-interrupt-vector-block-38">HBlank interrupt vector</a></em></strong></span>
<pre class="prettyprint"><code class="">reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#interrupt-vectors-block-34" title="Interrupt vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="timer-interrupt-vector-block-40" href="#timer-interrupt-vector-block-40">Timer interrupt vector</a></em></strong></span>
<pre class="prettyprint"><code class="">reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#interrupt-vectors-block-34" title="Interrupt vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="serial-interrupt-vector-block-42" href="#serial-interrupt-vector-block-42">Serial interrupt vector</a></em></strong></span>
<pre class="prettyprint"><code class="">reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#interrupt-vectors-block-34" title="Interrupt vectors">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="joypad-interrupt-vector-block-44" href="#joypad-interrupt-vector-block-44">Joypad interrupt vector</a></em></strong></span>
<pre class="prettyprint"><code class="">reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#interrupt-vectors-block-34" title="Interrupt vectors">1</a> </small></p></div>




<h2>6. Entry point and header<a id="s0:5"></a></h2>


<p>When the Game Boy is powered on, it loads the cartridge along with a 256 byte boot ROM that shows the Nintendo logo and plays the bootup sound. After the sequence finishes, it will instantly jump to address <code>$100</code>, which at this point it hands over control to my program.</p>

<p>There&rsquo;s not much room available here, because the header starts at address <code>$104</code>. So, I&rsquo;ll just do a jump to the <em>actual</em> initialization routine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="entry-point-block-46" href="#entry-point-block-46">Entry point</a></em></strong></span>
<pre class="prettyprint"><code class="">    jp Init
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>


<p>Next up is the Nintendo logo bitmap. The boot ROM checks this bitmap, and will lock up the Game Boy if it does not match. Fortunately, the linker will handle this automatically, so I don&rsquo;t need to include this data myself.</p>

<p>Right after <em>that</em>, I define the cartridge header. You can think of this as &ldquo;metadata&rdquo; about the game and the kind of cartridge it should be burned into. <a href="https://gbdev.io/pandocs/The_Cartridge_Header.html#the-cartridge-header">Here</a> is where you can find more information about its fields.</p>

<p>There are two checksums in the header, the header checksum and the global checksum, out of which the boot ROM will only check the former. The linker will handle both of these as well, so I simply set these to 0 here.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="header-block-48" href="#header-block-48">Header</a></em></strong></span>
<pre class="prettyprint"><code class="">    db "PONG FOR REAL  " ; game title
    db $00 ; cgb enabled ("no")
    db "ZD" ; new licensee code
    db $00 ; sgb enabled ("no")
    db $00 ; cart type ("ROM")
    db $00 ; rom size ("32k")
    db $00 ; ram size ("none")
    db $01 ; destination ("international")
    db $33 ; old licensee code ("use new instead")
    db $00 ; rom version
    db 0   ; header chksum, handled by linker
    dw 0   ; global chksum, handled by linker
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>




<h2>7. Main program layout<a id="s0:6"></a></h2>


<p>After the header, I can now get to work on the actual game. The code will start at address <code>$150</code>.
First, it&rsquo;ll run the initialization code. The game loop can start immediately after initialization. Afterwards, I&rsquo;ll place the helper functions. Those can actually be placed anywhere, but I want to place them after the &ldquo;main&rdquo; routines.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="main-program-block-50" href="#main-program-block-50">Main program</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode" title="part2.md"><a href="part2.html#initialization-code-block-75">@{Initialization code}</a></em>
<em class="block-link nocode" title="part3.md"><a href="part3.html#game-loop-code-block-188">@{Game loop code}</a></em>
<em class="block-link nocode"><a href="#helper-functions-block-54">@{Helper functions}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#-src-pong.asm-block-2" title="/src/pong.asm">1</a> </small></p></div>




<h2>8. Basic helper functions<a id="s0:7"></a></h2>


<h3>FillMem16</h3>

<p>I&rsquo;ll first define a couple of generic memory-filling functions here.</p>

<p>This one operates on a 16-bit length. It puts the value of A to the memory address pointed to by HL, increments HL, then repeats until the desired length is reached.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="fillmem16-block-52" href="#fillmem16-block-52">FillMem16</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Fill memory with HL continuously with A
;; for BC bytes
;;
;; @param A    value for fill
;; @param HL   start address
;; @param BC   how many bytes
;;
;; @return A   same
;; @return HL  HL + BC + 1
;; @return BC  0000
;;--
FillMem16::
    dec bc
    inc b
    inc c
.loop
    ld [hl+], a
    dec c
    jr nz, .loop
    dec b
    ret z
    jr .loop
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-54" title="Helper functions">1</a> </small></p></div>


<p>To use this function, I&rsquo;ll need to first set up its parameters by loading the appropriate registers with the correct values. Then I simply <code>call FillMem16</code>.</p>

<pre>
    ld a, 0
    ld hl, StartAddress
    ld bc, $1000
    call FillMem16
</pre>


<p>I&rsquo;ll add it to the list of helper functions.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-54" href="#helper-functions-block-54">Helper functions</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#fillmem16-block-52">@{FillMem16}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#main-program-block-50" title="Main program">1</a> </small></p></div>


<h3>FillMem8</h3>

<p>This one is the same as above, but operates on an 8-bit length instead. Instead of BC, this one uses only the C register.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="fillmem8-block-56" href="#fillmem8-block-56">FillMem8</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Fill memory with HL with A continuously for
;; C bytes
;;
;; @param A    value for fill
;; @param HL   start address
;; @param C    how many bytes
;;
;; @return A   same
;; @return HL  HL + C + 1
;; @return C   0
;;--
FillMem8::
.loop
    ld [hl+], a
    dec c
    jr nz, .loop
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-58" title="Helper functions">1</a> </small></p></div>


<p>Adding this one too.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-58" href="#helper-functions-block-58">Helper functions</a></em></strong> <a href="#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#fillmem8-block-56">@{FillMem8}</a></em>
</code></pre>
</div>


<p>Next up is the memory copying functions&hellip;</p>

<h3>CopyMem16</h3>

<p>Not only HL can be used for indirect memory addressing. BC and DE can be used as well. Although I can&rsquo;t also decrement and increment in one go&mdash;that would still need to be done through separate instructions.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="copymem16-block-60" href="#copymem16-block-60">CopyMem16</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Copies a portion of memory from DE to HL for
;; BC bytes.
;;
;; @param HL   destination start address
;; @param DE   source start address
;; @param BC   how many bytes
;;
;; @return A   Byte in (DE + BC)
;; @return HL  HL + BC + 1
;; @return BC  0000
;;--
CopyMem16::
    dec bc
    inc b
    inc c
.loop
    ld a, [de]
    inc de
    ld [hl+], a
    dec c
    jr nz, .loop
    dec b
    ret z
    jr .loop
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-62" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-62" href="#helper-functions-block-62">Helper functions</a></em></strong> <a href="#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#copymem16-block-60">@{CopyMem16}</a></em>
</code></pre>
</div>




<h2>9. VBlank<a id="s0:8"></a></h2>


<p>The vertical blank (VBlank) is a period of time where the Game Boy stops rendering the screen, because the <a href="https://gbdev.io/pandocs/STAT.html#ff44--ly-lcd-y-coordinate-read-only">scanline number set to be rendered</a> exceeds the height of the screen (144 lines). As execution goes on, the scanline number will keep incrementing until it reaches 153, after which loops back to zero, when the Game Boy will render the first scanline again.</p>

<p><figure>
<img src="../figures/vblank.svg">
</figure></p>

<p>Since the Game Boy isn&rsquo;t rendering the screen at this point, it&rsquo;s one of the safest places to do whatever I want relating to the screen&mdash;say, loading graphics or changing the background data. But as you can probably see, the catch is that there&rsquo;s not a whole lot of time available, so it&rsquo;s best not to stuff it with <em>everything</em>. In any case, I&rsquo;ll reserve it for now:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="vblank-interrupt-routine-block-64" href="#vblank-interrupt-routine-block-64">VBlank interrupt routine</a></em></strong></span>
<pre class="prettyprint"><code class="">VBlank::
<em class="block-link nocode"><a href="#save-registers-state-block-66">@{Save registers state}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#contents-of-vblank-block-119">@{Contents of VBlank}</a></em>
<em class="block-link nocode"><a href="#reload-registers-state-block-68">@{Reload registers state}</a></em>
    reti
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-70" title="Helper functions">1</a> </small></p></div>


<h3>Preserving the register state</h3>

<p>Because this is an interrupt routine, it can be triggered in the middle of program execution. To ensure the program can continue without unintended effects, I&rsquo;ll save the state of the current 16-bit register pairs to the Game Boy&rsquo;s stack through a few <code>push</code> instructions:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="save-registers-state-block-66" href="#save-registers-state-block-66">Save registers state</a></em></strong></span>
<pre class="prettyprint"><code class="">    push af
    push bc
    push de
    push hl
</code></pre>
<p class="block-usages"><small>Used by <a href="#vblank-interrupt-routine-block-64" title="VBlank interrupt routine">1</a> </small></p></div>


<p><figure>
<img src="../figures/stack.svg">
</figure></p>

<p>At the end of the routine, I&rsquo;ll have to reload them by <code>pop</code>ping them back in. Because it&rsquo;s a first-in-last-out stack, the registers need to be reloaded in <strong>reverse</strong> order.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reload-registers-state-block-68" href="#reload-registers-state-block-68">Reload registers state</a></em></strong></span>
<pre class="prettyprint"><code class="">    pop hl
    pop de
    pop bc
    pop af
</code></pre>
<p class="block-usages"><small>Used by <a href="#vblank-interrupt-routine-block-64" title="VBlank interrupt routine">1</a> </small></p></div>


<p>If the same ordering is used as the one to save registers, then HL would end up in AF, DE would end up in BC, etc.</p>

<p>(I should point out at this point that F isn&rsquo;t an actual register&mdash;it&rsquo;s just paired with A for the <code>push af</code> instruction.)</p>

<h3>Adding it to the ROM</h3>

<p>I&rsquo;ll add this in the &ldquo;helper functions&rdquo; slot, I guess.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-70" href="#helper-functions-block-70">Helper functions</a></em></strong> <a href="#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#vblank-interrupt-routine-block-64">@{VBlank interrupt routine}</a></em>
</code></pre>
</div>


<h3>Setting the interrupt vector</h3>

<p>All that&rsquo;s needed is just a jump instruction to make the Game Boy execute the routine when VBlank is reached:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="vblank-interrupt-vector-block-72" href="#vblank-interrupt-vector-block-72">VBlank interrupt vector</a></em></strong> <a href="#vblank-interrupt-vector-block-36">:=</a></span>
<pre class="prettyprint"><code class="">jp VBlank
</code></pre>
</div>

</body>
</html>
