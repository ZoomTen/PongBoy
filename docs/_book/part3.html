<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Making the main game loop</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave https://github.com/justinmeiners/srcweave -->


<h1>Making the main game loop<a id="c2"></a></h1>


<p>Now that everything is set up, it&rsquo;s time to get into the actual game. The flow here is processing input first, and then acting based on the received inputs.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-loop-code-block-188" href="#game-loop-code-block-188">Game loop code</a></em></strong></span>
<pre class="prettyprint"><code class="">GameLoop::
<em class="block-link nocode"><a href="#handle-joypad-input-block-222">@{Handle joypad input}</a></em>
<em class="block-link nocode"><a href="#handle-ball-physics-block-262">@{Handle ball physics}</a></em>
<em class="block-link nocode"><a href="#update-screen-block-202">@{Update screen}</a></em>
<em class="block-link nocode"><a href="#wait-one-frame-block-190">@{Wait one frame}</a></em>
    jp GameLoop
</code></pre>
<p class="block-usages"><small>Used by <a href="part1.html#main-program-block-50" title="Main program. part1.md">1</a> </small></p></div>


<p>I wait for one frame to pass first (so as to run the loop once per frame), and then return to the start of the loop. If I didn&rsquo;t wait a frame first, then the loop would run like a billion times per frame and be actually unplayable, which isn&rsquo;t what I want.</p>

<h2>1. Updating the screen<a id="s2:0"></a></h2>


<h3>Stepping one frame at a time</h3>

<p>The first thing I&rsquo;ll do in the game&rsquo;s main loop is to make sure that the logic is run once per frame. This <code>halt</code> instruction will wait until an interrupt is encountered, and then it&rsquo;ll resume executing. Since I have VBlank enabled at this point, this is an advantage. Using <code>halt</code> over waiting for VBlank myself saves battery since the Game Boy doesn&rsquo;t have to keep checking all the time if VBlank is reached or not.</p>

<p>The downside however, is that there&rsquo;s a <a href="https://gbdev.io/pandocs/halt.html#halt-bug">hardware bug</a> which sometimes causes the instruction after <code>halt</code> to be executed twice. I&rsquo;ll place a <code>nop</code> below just to be safe, so that if it happens the Game Boy will do nothing (twice).</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wait-one-frame-block-190" href="#wait-one-frame-block-190">Wait one frame</a></em></strong></span>
<pre class="prettyprint"><code class="">    halt
    nop
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-188" title="Game loop code">1</a> <a href="part4.html#game-loop-code-block-363" title="Game loop code. part4.md">2</a> </small></p></div>


<p>But since <code>halt</code> waits for <em>any</em> interrupt, it might be a good idea at this point to specifically ask for VBlank, in case I add any more interrupt handlers. I&rsquo;ll do this by having a flag that will be acknowledged when the VBlank interrupt is encountered.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hram-definitions-block-192" href="#hram-definitions-block-192">HRAM definitions</a></em></strong> <a href="part2.html#hram-definitions-block-79">+=</a></span>
<pre class="prettyprint"><code class="">hAskVBlank:: db
</code></pre>
</div>


<p>It&rsquo;s acknowledged by zeroing it out:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="contents-of-vblank-block-194" href="#contents-of-vblank-block-194">Contents of VBlank</a></em></strong> <a href="part2.html#contents-of-vblank-block-119">+=</a></span>
<pre class="prettyprint"><code class="">    xor a
    ldh [hAskVBlank], a
</code></pre>
</div>


<p>Now I&rsquo;ll create a function that specifically waits for VBlank. It sets <code>hAskVBlank</code> and checks if it has been acknowledged.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="delayframe-block-196" href="#delayframe-block-196">DelayFrame</a></em></strong></span>
<pre class="prettyprint"><code class="">DelayFrame::
    ld a, 1
    ldh [hAskVBlank], a
.loop
    halt
    nop
    ldh a, [hAskVBlank]
    and a
    ret z  ; exit if vblank is acknowledged
    jr .loop
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-198" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-198" href="#helper-functions-block-198">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#delayframe-block-196">@{DelayFrame}</a></em>
</code></pre>
</div>


<p>And then I&rsquo;ll replace this frame-waiting code with a single call to the new function:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wait-one-frame-block-200" href="#wait-one-frame-block-200">Wait one frame</a></em></strong> <a href="#wait-one-frame-block-190">:=</a></span>
<pre class="prettyprint"><code class="">    call DelayFrame
</code></pre>
</div>


<h3>Updating the sprites</h3>

<p>Sprite updating is done from within the game logic. I&rsquo;ll just reuse the <a href="initialization-4.html#8.3:3">sprite setup routines</a> from earlier, since it&rsquo;s easier for me to just reinitialize the sprites rather than manually changing their positions one by one.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="update-screen-block-202" href="#update-screen-block-202">Update screen</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#update-sprite-positions-block-204">@{Update sprite positions}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-188" title="Game loop code">1</a> <a href="part4.html#gm_game-loop-code-block-389" title="GM_Game loop code. part4.md">2</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="update-sprite-positions-block-204" href="#update-sprite-positions-block-204">Update sprite positions</a></em></strong></span>
<pre class="prettyprint"><code class="">    call SetupLeftPaddle
    call SetupRightPaddle
    call SetupBall
</code></pre>
<p class="block-usages"><small>Used by <a href="#update-screen-block-202" title="Update screen">1</a> </small></p></div>


<h3>Updating the score display</h3>

<p>I <em>could</em> try to make this update <em>within</em> the main loop, because it is possible to update VRAM outside of VBlank. However that requires a wait until the VRAM is writable for each operation, and that may be a bit risky. So, I want to just do it in VBlank instead.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="contents-of-vblank-block-206" href="#contents-of-vblank-block-206">Contents of VBlank</a></em></strong> <a href="part2.html#contents-of-vblank-block-119">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#update-the-score-display-block-210">@{Update the score display}</a></em>
</code></pre>
</div>


<p>I&rsquo;ll throw in some more constants to set the starting point of the scores within the tilemap.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-208" href="#constants-block-208">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">LEFT_SCORE_VRAM_START equ $9846
RIGHT_SCORE_VRAM_START equ $984C
</code></pre>
</div>


<p><code>ShowScore</code> is going to just use A and HL for the input.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="update-the-score-display-block-210" href="#update-the-score-display-block-210">Update the score display</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wLeftScore]
    ld hl, LEFT_SCORE_VRAM_START
    call ShowScore
    
    ld a, [wRightScore]
    ld hl, RIGHT_SCORE_VRAM_START
    call ShowScore
</code></pre>
<p class="block-usages"><small>Used by <a href="#contents-of-vblank-block-206" title="Contents of VBlank">1</a> </small></p></div>


<p>And <code>ShowScore</code> is defined&hellip; here:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="showscore-block-212" href="#showscore-block-212">ShowScore</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; 
;; @param A     score value, BCD
;; @param HL    where in VRAM to place it in
;; 
;; @clobber BC  the split score value
;; @clobber DE  $20 - 1
;;--
ShowScore::
<em class="block-link nocode"><a href="#split-score-into-two-numbers-block-216">@{Split score into two numbers}</a></em>
<em class="block-link nocode"><a href="#print-top-half-of-the-score-block-218">@{Print top half of the score}</a></em>
<em class="block-link nocode"><a href="#print-bottom-half-of-the-score-block-220">@{Print bottom half of the score}</a></em>
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-214" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-214" href="#helper-functions-block-214">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#showscore-block-212">@{ShowScore}</a></em>
</code></pre>
</div>


<p>I&rsquo;m going to assume that the scoring system operates on <a href="https://en.wikipedia.org/wiki/Binary-coded_decimal">binary-coded decimal</a> (BCD). Practically speaking, it just means that the two halves of the score&rsquo;s <em>hexadecimal representation</em> never go past 9, so no <code>A</code>, <code>B</code>, <code>C</code>, <code>D</code>, <code>E</code>, or <code>F</code>. Sure, the number won&rsquo;t accurately represent the score as <em>data</em>, but in the interest of making an &ldquo;easy&rdquo; implementation, it&rsquo;ll do.</p>

<p>First I&rsquo;ll split the number into two parts, and then add them to the starting tile of the numeral &ldquo;0&rdquo; in the tileset.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="split-score-into-two-numbers-block-216" href="#split-score-into-two-numbers-block-216">Split score into two numbers</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld b, a  ; save original number

; get the lower half and put it into C
    and %00001111
    add $10 ; starting tile of numeral "0"
    ld c, a

; get the upper half and put it into B
    ld a, b
    and %11110000
    swap a  ; make it the lower half
    add $10 ; starting tile of numeral "0"
    ld b, a
</code></pre>
<p class="block-usages"><small>Used by <a href="#showscore-block-212" title="ShowScore">1</a> </small></p></div>


<p>The score&rsquo;s &ldquo;tens&rdquo; position is now in B, while the &ldquo;ones&rdquo; are in C. All that&rsquo;s left to do is to put them in memory.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="print-top-half-of-the-score-block-218" href="#print-top-half-of-the-score-block-218">Print top half of the score</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld [hl], b
    inc hl
    ld [hl], c
</code></pre>
<p class="block-usages"><small>Used by <a href="#showscore-block-212" title="ShowScore">1</a> </small></p></div>


<p>I&rsquo;ll have to move the cursor down, then write the lower half. I&rsquo;ll add to BC by <code>$10</code>, since the lower half of the numbers in the tile set comes right after the upper half.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="print-bottom-half-of-the-score-block-220" href="#print-bottom-half-of-the-score-block-220">Print bottom half of the score</a></em></strong></span>
<pre class="prettyprint"><code class="">; move VRAM position
    ld de, $20 - 1
    add hl, de

; I assume the lower half comes directly
; after the upper half, so add the offset
; to b and c
    ld a, 10
    add b
    ld b, a
    ld a, 10
    add c
    ld c, a

; put it to the screen
    ld [hl], b
    inc hl
    ld [hl], c
</code></pre>
<p class="block-usages"><small>Used by <a href="#showscore-block-212" title="ShowScore">1</a> </small></p></div>




<h2>2. First visuals<a id="s2:1"></a></h2>


<p>So far, I should have a static screen of just the game objects, the background, and the scoreboard.</p>

<p>If I fiddle around with the memory locations of the paddle positions and whatnot, I can move them &ldquo;interactively&rdquo;. A good sign. That means I can just fiddle around with these locations within game code, which I&rsquo;ll do next.</p>

<p><figure>
<img width="400" src="../figures/2023-04-20_09-09.png" alt="Basic pong screen with score 0-0">
</figure></p>

<h2>3. Input handling<a id="s2:2"></a></h2>


<p>The player&rsquo;s controller should be able to control the paddles. My plan here is to have the player control the left paddle, while the right paddle is a CPU opponent.</p>

<p>So I&rsquo;ll build the input handling routine thus:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-joypad-input-block-222" href="#handle-joypad-input-block-222">Handle joypad input</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#handle-the-left-paddle-block-248">@{Handle the left paddle}</a></em>
<em class="block-link nocode"><a href="#handle-the-right-paddle-block-256">@{Handle the right paddle}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-188" title="Game loop code">1</a> <a href="part4.html#gm_game-loop-code-block-389" title="GM_Game loop code. part4.md">2</a> </small></p></div>


<h3>Joypad routine</h3>

<p>I&rsquo;ll need a way to read the Game Boy&rsquo;s button inputs and store them somewhere to be referred later. I&rsquo;ll place the destination address to HRAM:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hram-definitions-block-224" href="#hram-definitions-block-224">HRAM definitions</a></em></strong> <a href="part2.html#hram-definitions-block-79">+=</a></span>
<pre class="prettyprint"><code class="">hInput:: db
</code></pre>
</div>


<p>And an outline of the function to be written:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="readjoypad-block-226" href="#readjoypad-block-226">ReadJoypad</a></em></strong></span>
<pre class="prettyprint"><code class="">ReadJoypad::
    <em class="block-link nocode"><a href="#read-d-pad-input-and-store-block-232">@{Read d-pad input and store}</a></em>
    <em class="block-link nocode"><a href="#read-button-input-and-store-block-238">@{Read button input and store}</a></em>
    <em class="block-link nocode"><a href="#reset-the-joypad-register-block-242">@{Reset the joypad register}</a></em>
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-228" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-228" href="#helper-functions-block-228">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#readjoypad-block-226">@{ReadJoypad}</a></em>
</code></pre>
</div>


<p>The d-pad input and button input are treated separately by <code>rJOYP</code>, as can be seen <a href="https://gbdev.io/pandocs/Joypad_Input.html">from the docs</a>.</p>

<p>The explanation says writing 0 to P14/P15 will select the appropriate button set, but really is writing a 1 into <em>the opposite</em> of the selected button set.</p>

<p>So I make flag constants to reflect this.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-230" href="#constants-block-230">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">F_rJOYP_SELECT_NOT_DPAD    equ 4
F_rJOYP_SELECT_NOT_BUTTONS equ 5
</code></pre>
</div>


<p>First I select the d-pad (that is to say, &ldquo;not buttons&rdquo;). It sets up this register to listen for d-pad inputs.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="read-d-pad-input-and-store-block-232" href="#read-d-pad-input-and-store-block-232">Read d-pad input and store</a></em></strong></span>
<pre class="prettyprint"><code class="">ld a, 1 &lt;&lt; F_rJOYP_SELECT_NOT_BUTTONS
ldh [rJOYP], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#readjoypad-block-226" title="ReadJoypad">1</a> </small></p></div>


<p>Then I read the input several times, because analog controls are funny. This allows the inputs to stabilize.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="read-d-pad-input-and-store-block-234" href="#read-d-pad-input-and-store-block-234">Read d-pad input and store</a></em></strong> <a href="#read-d-pad-input-and-store-block-232">+=</a></span>
<pre class="prettyprint"><code class="">rept 4
ldh a, [rJOYP]
endr
</code></pre>
</div>


<p>The result is stored where everything is 1 except the bits for which the corresponding buttons were set. I want to see a 1 where the button is pressed, so I inverted the result, grabbed only the lower half and swapping it with the upper half, then store temporarily.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="read-d-pad-input-and-store-block-236" href="#read-d-pad-input-and-store-block-236">Read d-pad input and store</a></em></strong> <a href="#read-d-pad-input-and-store-block-232">+=</a></span>
<pre class="prettyprint"><code class="">cpl       ; flip all the bits
and %1111 ; get only lower half
swap a    ; make it the upper half
ld b, a   ; store to b
</code></pre>
</div>


<p>Doing the same to the button inputs.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="read-button-input-and-store-block-238" href="#read-button-input-and-store-block-238">Read button input and store</a></em></strong></span>
<pre class="prettyprint"><code class="">ld a, 1 &lt;&lt; F_rJOYP_SELECT_NOT_DPAD
ldh [rJOYP], a
rept 4
ldh a, [rJOYP]
endr
</code></pre>
<p class="block-usages"><small>Used by <a href="#readjoypad-block-226" title="ReadJoypad">1</a> </small></p></div>


<p>This time, I get to OR it with the value I saved earlier.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="read-button-input-and-store-block-240" href="#read-button-input-and-store-block-240">Read button input and store</a></em></strong> <a href="#read-button-input-and-store-block-238">+=</a></span>
<pre class="prettyprint"><code class="">cpl              ; flip all the bits
and %1111        ; get only lower half
or b             ; merge with the d-pad input earlier
ldh [hInput], a  ; save
</code></pre>
</div>


<p>I don&rsquo;t need to manipulate the joypad anymore, so I&rsquo;ll try resetting rJOYP.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-joypad-register-block-242" href="#reset-the-joypad-register-block-242">Reset the joypad register</a></em></strong></span>
<pre class="prettyprint"><code class="">ld a, 1 &lt;&lt; F_rJOYP_SELECT_NOT_BUTTONS | (1 &lt;&lt; F_rJOYP_SELECT_NOT_DPAD)
ldh [rJOYP], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#readjoypad-block-226" title="ReadJoypad">1</a> </small></p></div>


<h3>Define joypad constants</h3>

<p>The subroutine above places the d-pad set in the upper half (bits 4-7), and the buttons set in the lower half (bits 0-3). <code>hInput</code> can be checked with e.g. the <code>bit &lt;N&gt;, a</code> instruction to see if a certain button is pressed. Let&rsquo;s define the button flag numbers here:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-244" href="#constants-block-244">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">BUTTONF_A      equ 0
BUTTONF_B      equ 1
BUTTONF_SELECT equ 2
BUTTONF_START  equ 3
BUTTONF_RIGHT  equ 4
BUTTONF_LEFT   equ 5
BUTTONF_UP     equ 6
BUTTONF_DOWN   equ 7
</code></pre>
</div>


<p>Just in case I&rsquo;ll want to check a specific button combination, I&rsquo;ll define its numerical equivalents as well:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-246" href="#constants-block-246">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">BUTTON_A      equ 1&lt;&lt;BUTTONF_A
BUTTON_B      equ 1&lt;&lt;BUTTONF_B
BUTTON_SELECT equ 1&lt;&lt;BUTTONF_SELECT
BUTTON_START  equ 1&lt;&lt;BUTTONF_START
BUTTON_RIGHT  equ 1&lt;&lt;BUTTONF_RIGHT
BUTTON_LEFT   equ 1&lt;&lt;BUTTONF_LEFT
BUTTON_UP     equ 1&lt;&lt;BUTTONF_UP
BUTTON_DOWN   equ 1&lt;&lt;BUTTONF_DOWN
</code></pre>
</div>


<h3>Handle the left paddle</h3>

<p>Pong controls are simple&mdash;move paddles up and down. Since this will be run once every frame, I check the joypad via the routine from earlier and then jump depending whether the up or down button is pressed. I&rsquo;m using a compare here because I want to check if <em>only</em> up or <em>only</em> down is pressed, but not both (even though that will resolve to &ldquo;up&rdquo; anyway, since up is processed first).</p>

<p>This section could be read as having early <code>ret</code>, except the <code>ret</code> is replaced with a jump to the next section of the code here.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-the-left-paddle-block-248" href="#handle-the-left-paddle-block-248">Handle the left paddle</a></em></strong></span>
<pre class="prettyprint"><code class="">.left_paddle
    call ReadJoypad
    ldh a, [hInput]
    jr z, .left_paddle_done
    
    cp BUTTON_UP
    jr z, .up
    
    cp BUTTON_DOWN
    jr z, .down
    
    jr .left_paddle_done

.up
<em class="block-link nocode"><a href="#move-the-left-paddle-up-block-252">@{Move the left paddle up}</a></em>

.down
<em class="block-link nocode"><a href="#move-the-left-paddle-down-block-254">@{Move the left paddle down}</a></em>

.left_paddle_done
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-joypad-input-block-222" title="Handle joypad input">1</a> <a href="#helper-functions-block-260" title="Helper functions">2</a> </small></p></div>


<p>I define some constants for the paddle&rsquo;s speed (this is currently static; used in the <code>rept</code> directive), and the upper and lower boundaries where the paddle can&rsquo;t move any further.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-250" href="#constants-block-250">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">; this is a static constant
PADDLE_SPEED equ 2

; Y boundaries
PADDLES_UPPER_BOUNDARY equ $18
PADDLES_LOWER_BOUNDARY equ $70
</code></pre>
</div>


<p>Moving the paddle up is basically decrementing <code>wLeftPaddleY</code> (since the value encodes how far <em>down</em> the screen it is) with a check to cap it at the desired boundaries.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-left-paddle-up-block-252" href="#move-the-left-paddle-up-block-252">Move the left paddle up</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wLeftPaddleY]

    rept PADDLE_SPEED
    dec a
    endr
    
    cp PADDLES_UPPER_BOUNDARY
    jr nc, .apply_up

; cap position
    ld a, PADDLES_UPPER_BOUNDARY

.apply_up
    ld [wLeftPaddleY], a
    jr .left_paddle_done
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-left-paddle-block-248" title="Handle the left paddle">1</a> </small></p></div>


<p>Same with moving it down, except it increments instead.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-left-paddle-down-block-254" href="#move-the-left-paddle-down-block-254">Move the left paddle down</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wLeftPaddleY]
    
    rept PADDLE_SPEED
    inc a
    endr
    
    cp PADDLES_LOWER_BOUNDARY
    jr c, .apply_down

; cap position
    ld a, PADDLES_LOWER_BOUNDARY

.apply_down
    ld [wLeftPaddleY], a
    jr .left_paddle_done
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-left-paddle-block-248" title="Handle the left paddle">1</a> </small></p></div>


<h3>Handle the right paddle</h3>

<p>Since the right paddle isn&rsquo;t going to be controlled by the player, I&rsquo;ll leave this empty for now.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-the-right-paddle-block-256" href="#handle-the-right-paddle-block-256">Handle the right paddle</a></em></strong></span>
<pre class="prettyprint"><code class="">.right_paddle
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-joypad-input-block-222" title="Handle joypad input">1</a> <a href="#helper-functions-block-260" title="Helper functions">2</a> </small></p></div>


<h3>Split into subroutines</h3>

<p>Okay, so it turns out that I might want to split these into subroutines, after all. Sure, splitting it and then <code>call</code>ing them is a bit slower than just placing the code directly, but it helps with readability.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-joypad-input-block-258" href="#handle-joypad-input-block-258">Handle joypad input</a></em></strong> <a href="#handle-joypad-input-block-222">:=</a></span>
<pre class="prettyprint"><code class="">    call HandleLeftPaddleInput
    call HandleRightPaddleInput
</code></pre>
</div>


<p>Remember when I said about early <code>ret</code> earlier in this page? I turned it into a real-deal early <code>ret</code>:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-260" href="#helper-functions-block-260">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class="">HandleLeftPaddleInput::
<em class="block-link nocode"><a href="#handle-the-left-paddle-block-248">@{Handle the left paddle}</a></em>
    ret

HandleRightPaddleInput::
<em class="block-link nocode"><a href="#handle-the-right-paddle-block-256">@{Handle the right paddle}</a></em>
    ret
</code></pre>
</div>


<p>Effectively, this means the <code>jr z, .done</code> instructions (and similar) within those functions can be optimized away to a <code>ret z</code>. But I&rsquo;m not doing that here, because this markup system as it is would make me rewrite entire sections for that&hellip;</p>

<h2>4. Ball physics<a id="s2:3"></a></h2>


<p>Well, I&rsquo;ll try. The ball will be moving at a single speed value, so I&rsquo;ll have the game try to determine the ball&rsquo;s next direction and then apply that &ldquo;vector&rdquo; to the ball. It&rsquo;s similar to how the input handling works, really.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-ball-physics-block-262" href="#handle-ball-physics-block-262">Handle ball physics</a></em></strong></span>
<pre class="prettyprint"><code class="">    call DetermineBallDirection
    call ApplyBallMovement
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-188" title="Game loop code">1</a> <a href="part4.html#gm_game-loop-code-block-389" title="GM_Game loop code. part4.md">2</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-264" href="#helper-functions-block-264">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class="">DetermineBallDirection::
<em class="block-link nocode"><a href="#determine-ball-s-next-movement-block-272">@{Determine ball's next movement}</a></em>
    ret

ApplyBallMovement::
<em class="block-link nocode"><a href="#apply-ball-movement-block-270">@{Apply ball movement}</a></em>
    ret
</code></pre>
</div>


<p>I&rsquo;ll want to keep track of the ball&rsquo;s direction. Uses three bits: one for the horizontal direction, another for the vertical, and an extra one just because I wanted the ball to start serving straight in the direction of the paddles.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-266" href="#wram-definitions-block-266">WRAM definitions</a></em></strong> <a href="part2.html#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">;;--
;; bit 0: left (0) / right (1)
;; bit 1: up (0) / down (1)
;; bit 2: no vertical momentum (0) / vertical momentum (1)
;;--
wBallNextDirection:: db
</code></pre>
</div>


<p>And the matching flag constants.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-268" href="#constants-block-268">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">; wBallNextDirection bits
F_HORIZONTAL equ 0
F_VERTICAL   equ 1
F_APPLY_VERTICAL equ 2
</code></pre>
</div>


<p>I&rsquo;ll first write up the game applying the determined direction, since that&rsquo;s the easier bit.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="apply-ball-movement-block-270" href="#apply-ball-movement-block-270">Apply ball movement</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#apply-horizontal-movement-block-274">@{Apply horizontal movement}</a></em>

.apply_ball_y
<em class="block-link nocode"><a href="#apply-vertical-movement-block-282">@{Apply vertical movement}</a></em>

.finished_applying
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-264" title="Helper functions">1</a> </small></p></div>


<p>Determining the direction itself is a bit more involved, since that&rsquo;s basically the collision checking routine. Instead of checking if the ball is touching another sprite, I want to use hard ranges.</p>

<p>The ball will bounce in both the X and Y directions when it hits a paddle, but only in the Y direction when it hits a wall.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-ball-s-next-movement-block-272" href="#determine-ball-s-next-movement-block-272">Determine ball's next movement</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#determine-if-the-ball-collides-with-anything-block-290">@{Determine if the ball collides with anything}</a></em>

.switch_directions
<em class="block-link nocode"><a href="#switch-ball-directions-block-308">@{Switch ball directions}</a></em>
    jr .skip_collision

.switch_only_y_direction
<em class="block-link nocode"><a href="#switch-ball-directions-but-only-the-y-axis-block-314">@{Switch ball directions but only the Y axis}</a></em>

.skip_collision
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-264" title="Helper functions">1</a> </small></p></div>


<h3>Apply horizontal movement</h3>

<p>First, let&rsquo;s deal with how the ball moves horizontally.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="apply-horizontal-movement-block-274" href="#apply-horizontal-movement-block-274">Apply horizontal movement</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#determine-the-ball-s-new-horizontal-direction-block-276">@{Determine the ball's new horizontal direction}</a></em>

.move_ball_right
<em class="block-link nocode"><a href="#move-the-ball-to-the-right-block-278">@{Move the ball to the right}</a></em>
    jr .apply_ball_y

.move_ball_left
<em class="block-link nocode"><a href="#move-the-ball-to-the-left-block-280">@{Move the ball to the left}</a></em>
    ; jr .apply_ball_y
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-ball-movement-block-270" title="Apply ball movement">1</a> </small></p></div>


<p>I get the next ball&rsquo;s next direction and store it in B, because I&rsquo;ll change A a bunch in the following sections. That way I can reuse the original value should A be changed.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-the-ball-s-new-horizontal-direction-block-276" href="#determine-the-ball-s-new-horizontal-direction-block-276">Determine the ball's new horizontal direction</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wBallNextDirection]
; store next direction in b
    ld b, a
; load horizontal position
    ld hl, wBallX
    bit F_HORIZONTAL, b
    jr z, .move_ball_left
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-horizontal-movement-block-274" title="Apply horizontal movement">1</a> </small></p></div>


<p>I pointed HL to <code>wBallX</code> and simply incremented and decremented it directly.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-to-the-right-block-278" href="#move-the-ball-to-the-right-block-278">Move the ball to the right</a></em></strong></span>
<pre class="prettyprint"><code class="">    inc [hl]
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-horizontal-movement-block-274" title="Apply horizontal movement">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-to-the-left-block-280" href="#move-the-ball-to-the-left-block-280">Move the ball to the left</a></em></strong></span>
<pre class="prettyprint"><code class="">    dec [hl]
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-horizontal-movement-block-274" title="Apply horizontal movement">1</a> </small></p></div>


<h3>Apply vertical movement</h3>

<p>Next up is the ball&rsquo;s vertical movement. This is similar to the previous section.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="apply-vertical-movement-block-282" href="#apply-vertical-movement-block-282">Apply vertical movement</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#determine-the-ball-s-new-vertical-direction-block-284">@{Determine the ball's new vertical direction}</a></em>

.move_ball_down
<em class="block-link nocode"><a href="#move-the-ball-down-block-286">@{Move the ball down}</a></em>
    jr .finished_applying

.move_ball_up
<em class="block-link nocode"><a href="#move-the-ball-up-block-288">@{Move the ball up}</a></em>
    ; jr .finished_applying
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-ball-movement-block-270" title="Apply ball movement">1</a> </small></p></div>


<p>Since there&rsquo;s a flag to apply the vertical movement, I&rsquo;ll check for that as well. If that&rsquo;s not set, it skips processing the vertical movement.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-the-ball-s-new-vertical-direction-block-284" href="#determine-the-ball-s-new-vertical-direction-block-284">Determine the ball's new vertical direction</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, wBallY
    bit F_APPLY_VERTICAL, b
    jr z, .finished_applying
    bit F_VERTICAL, b
    jr z, .move_ball_up
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-vertical-movement-block-282" title="Apply vertical movement">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-down-block-286" href="#move-the-ball-down-block-286">Move the ball down</a></em></strong></span>
<pre class="prettyprint"><code class="">    inc [hl]
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-vertical-movement-block-282" title="Apply vertical movement">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-up-block-288" href="#move-the-ball-up-block-288">Move the ball up</a></em></strong></span>
<pre class="prettyprint"><code class="">    dec [hl]
</code></pre>
<p class="block-usages"><small>Used by <a href="#apply-vertical-movement-block-282" title="Apply vertical movement">1</a> </small></p></div>


<h3>Collision checking</h3>

<p>Well, time for the collision check. I&rsquo;ll first check if the ball hits any of the paddles' X coordinates, and if so, jumps to the paddle collision check portion. I&rsquo;ll also check if the ball collides with the top and bottom of the arena.</p>

<p>The paddle collision routines are its own little thing here, since the line before it is basically another early return.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-if-the-ball-collides-with-anything-block-290" href="#determine-if-the-ball-collides-with-anything-block-290">Determine if the ball collides with anything</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#check-if-the-ball-hits-the-paddles--x-coordinates-block-292">@{Check if the ball hits the paddles' X coordinates}</a></em>
<em class="block-link nocode"><a href="#check-if-the-ball-is-colliding-with-the-top-and-bottom-of-the-arena-block-310">@{Check if the ball is colliding with the top and bottom of the arena}</a></em>
    jr .skip_collision

.check_left_colliding
<em class="block-link nocode"><a href="#check-if-the-ball-is-touching-the-left-paddle-block-298">@{Check if the ball is touching the left paddle}</a></em>

.check_right_colliding
<em class="block-link nocode"><a href="#check-if-the-ball-is-touching-the-right-paddle-block-306">@{Check if the ball is touching the right paddle}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-ball-s-next-movement-block-272" title="Determine ball's next movement">1</a> </small></p></div>


<h3>Checking if the ball is in the range of the paddles</h3>

<p><figure>
<img src="../figures/collide1.svg">
</figure></p>

<p>First I&rsquo;ll check if it&rsquo;s in or beyond the line of the left paddle. I&rsquo;ll add the paddle&rsquo;s width to the offset because the line to be checked is to the right of the paddle.</p>

<p>I&rsquo;ll also check if the ball is to the right of where the left paddle begins, that way the ball won&rsquo;t collide with the space at the back of the paddle.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-hits-the-paddles--x-coordinates-block-292" href="#check-if-the-ball-hits-the-paddles--x-coordinates-block-292">Check if the ball hits the paddles' X coordinates</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wBallX]
    cp LEFT_PADDLE_X + PADDLE_WIDTH
    
; [wBallX] &lt;= (LEFT_PADDLE_X + PADDLE_WIDTH)
    jr c, .additional_left_check
    jr z, .additional_left_check
    
    jr .left_x_done

.additional_left_check
    cp LEFT_PADDLE_X
; [wBallX] &gt;= (LEFT_PADDLE_X)
    jr nc, .check_left_colliding

.left_x_done
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-if-the-ball-collides-with-anything-block-290" title="Determine if the ball collides with anything">1</a> </small></p></div>


<p>Then I&rsquo;ll check if it&rsquo;s in or beyond the line of the right paddle. In this case, the line is to the left of the paddle. Likewise with making sure it doesn&rsquo;t collide with blank space.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-hits-the-paddles--x-coordinates-block-294" href="#check-if-the-ball-hits-the-paddles--x-coordinates-block-294">Check if the ball hits the paddles' X coordinates</a></em></strong> <a href="#check-if-the-ball-hits-the-paddles--x-coordinates-block-292">+=</a></span>
<pre class="prettyprint"><code class="">    cp RIGHT_PADDLE_X - PADDLE_WIDTH
    
; [wBallX] &gt;= (RIGHT_PADDLE_X - PADDLE_WIDTH)
    jr nc, .additional_right_check
    
    jr .right_x_done

.additional_right_check
    cp RIGHT_PADDLE_X + PADDLE_WIDTH
    jr c, .check_right_colliding

.right_x_done
</code></pre>
</div>


<p>The paddle&rsquo;s graphics are 1 tile wide, and 1 tile is 8 pixels wide. So:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-296" href="#constants-block-296">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">PADDLE_WIDTH equ 8 ; pixels
</code></pre>
</div>


<h3>Simple paddle collision</h3>

<p><figure>
<img src="../figures/collide2.svg">
</figure></p>

<p>Now, I&rsquo;ve checked that the ball is in the paddle&rsquo;s <em>horizontal</em> range. Let&rsquo;s say it passes. I&rsquo;ll now have to check the <em>vertical</em> range, because the paddles aren&rsquo;t of infinite height <s>unlike some games I can mention</s>.</p>

<p>I want this to collide when (<code>wLeftPaddleY</code> &leq; <code>wBallY</code> &leq; <code>wLeftPaddleY + PADDLE_HEIGHT</code>).</p>

<p>That is, to say: ((<code>wLeftPaddleY</code> &leq; <code>wBallY</code>) AND (<code>wBallY</code> &leq; <code>wLeftPaddleY + PADDLE_HEIGHT</code>)).</p>

<p>But checking this way would be tricky, so I can invert this to make the ball <em>pass through</em> when: ((<code>wBallY</code> &lt; <code>wLeftPaddleY</code>) OR (<code>wBallY</code> &gt; <code>wLeftPaddleY + PADDLE_HEIGHT</code>)).</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-is-touching-the-left-paddle-block-298" href="#check-if-the-ball-is-touching-the-left-paddle-block-298">Check if the ball is touching the left paddle</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, wLeftPaddleY
    ld a, [wBallY]
    cp [hl]
; pass if wBallY &lt; wLeftPaddleY
    jr c, .skip_collision

    sub a, PADDLE_HEIGHT
    cp [hl]
; collide if wBallY-PADDLE_HEIGHT = wLeftPaddleY
    jr z, .switch_directions
; pass if wBallY-PADDLE_HEIGHT &gt; wLeftPaddleY
    jr nc, .skip_collision
    jr .switch_directions
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-if-the-ball-collides-with-anything-block-290" title="Determine if the ball collides with anything">1</a> </small></p></div>


<p>I wanted to reuse the value of <code>wBallY</code> somehow, so I expressed that right half as (<code>wBallY-PADDLE_HEIGHT</code> &gt; <code>wLeftPaddleY</code>).</p>

<p>While I&rsquo;m at it, I&rsquo;ll define the paddle height here, too. The paddle is 5 tiles tall, so 8 &times; 5 = 40 pixels&hellip;</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-300" href="#constants-block-300">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">PADDLE_HEIGHT equ 40 ; pixels
</code></pre>
</div>


<h3>Adding directional awareness</h3>

<p>That simple approach creates a bit of a problem where the direction will just be inverted no matter where the ball collided with the paddle. For example, the ball can bounce down even when it collided with the top of the paddle. Probably not what you&rsquo;ll expect of a standard Pong game.</p>

<p>I&rsquo;ll want to store how far the ball is from the top of the paddle. That way, the ball will bounce down only when it hits the bottom half of the paddle. Otherwise, it bounces up.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-302" href="#wram-definitions-block-302">WRAM definitions</a></em></strong> <a href="part2.html#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">wDeltaYFromPaddle:: db
</code></pre>
</div>


<p>Then I&rsquo;ll need to rework the previous logic to reflect this. I changed the first <code>cp [hl]</code> to <code>sub [hl]</code> to get the distance between the top of the paddle and the ball.</p>

<p>There&rsquo;s also no need to check against [HL] again, since I&rsquo;m working off of the calculated distance value.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-is-touching-the-left-paddle-block-304" href="#check-if-the-ball-is-touching-the-left-paddle-block-304">Check if the ball is touching the left paddle</a></em></strong> <a href="#check-if-the-ball-is-touching-the-left-paddle-block-298">:=</a></span>
<pre class="prettyprint"><code class="">    ld hl, wLeftPaddleY
    ld a, [wBallY]
    sub [hl]
; pass if wBallY &lt; wLeftPaddleY
    jr c, .skip_collision

; pass if wBallY-wLeftPaddleY &gt; PADDLE_HEIGHT
    cp PADDLE_HEIGHT
    jr z, .save_delta_and_collide_left
    jr nc, .skip_collision

.save_delta_and_collide_left
    ld [wDeltaYFromPaddle], a
    jr .switch_directions
</code></pre>
</div>


<h3>Right paddle collision</h3>

<p>Now that I&rsquo;ve got the left paddle collision worked out, it&rsquo;s a matter of applying the same thing to the right paddle. This is only processed when the ball hits the X position of the right paddle, so <code>wDeltaYFromPaddle</code> should still be correct here.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-is-touching-the-right-paddle-block-306" href="#check-if-the-ball-is-touching-the-right-paddle-block-306">Check if the ball is touching the right paddle</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, wRightPaddleY
    ld a, [wBallY]
    sub [hl]
    jr c, .skip_collision
    cp PADDLE_HEIGHT
    jr z, .save_delta_and_collide_right
    jr nc, .skip_collision
.save_delta_and_collide_right
    ld [wDeltaYFromPaddle], a
    jr .switch_directions
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-if-the-ball-collides-with-anything-block-290" title="Determine if the ball collides with anything">1</a> </small></p></div>


<h3>Switching directions</h3>

<p><figure>
<img src="../figures/collide3.svg">
</figure></p>

<p>Once a collision is detected, I can switch the ball&rsquo;s direction with respect to the delta Y position previously calculated. At this point, A = <code>wDeltaYFromPaddle</code>, so I don&rsquo;t need to load it again.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="switch-ball-directions-block-308" href="#switch-ball-directions-block-308">Switch ball directions</a></em></strong></span>
<pre class="prettyprint"><code class="">    cp PADDLE_HEIGHT/2
    ld a, [wBallNextDirection]
; bounce down if delta Y &gt; (PADDLE_HEIGHT/2)
    jr nc, .down
; up
    xor a, 1 &lt;&lt; F_HORIZONTAL  ; invert the horizontal direction
    res F_VERTICAL, a         ; move up
    jr .set_direction
.down
    xor a, 1 &lt;&lt; F_HORIZONTAL  ; invert the horizontal direction
    set F_VERTICAL, a         ; move down
.set_direction
    set F_APPLY_VERTICAL, a   ; always set the vertical apply flag
    ld [wBallNextDirection], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-ball-s-next-movement-block-272" title="Determine ball's next movement">1</a> </small></p></div>


<p>The <code>xor a, 1 &lt;&lt; F_HORIZONTAL</code> instruction couldn&rsquo;t be placed right after <code>wBallNextDirection</code> was retrieved, since I&rsquo;d lose the result of the <code>cp PADDLE_HEIGHT/2</code> instruction. So, that one is duplicated across branches.</p>

<h3>Colliding with the bounds of the arena</h3>

<p><figure>
<img src="../figures/collide4.svg">
</figure></p>

<p>Fortunately, this is a really simple check.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="check-if-the-ball-is-colliding-with-the-top-and-bottom-of-the-arena-block-310" href="#check-if-the-ball-is-colliding-with-the-top-and-bottom-of-the-arena-block-310">Check if the ball is colliding with the top and bottom of the arena</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wBallY]
    cp BALL_UPPER_BOUNDARY
; wBallY &lt; BALL_UPPER_BOUNDARY
    jr c, .switch_only_y_direction
    cp BALL_LOWER_BOUNDARY
; wBallY &gt; BALL_LOWER_BOUNDARY
    jr z, .skip_collision
    jr nc, .switch_only_y_direction
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-if-the-ball-collides-with-anything-block-290" title="Determine if the ball collides with anything">1</a> </small></p></div>


<p>Set the boundaries&hellip;</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-312" href="#constants-block-312">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">BALL_UPPER_BOUNDARY equ PADDLES_UPPER_BOUNDARY - 8
BALL_LOWER_BOUNDARY equ PADDLES_LOWER_BOUNDARY + (5*8)
</code></pre>
</div>


<p>&hellip;And flip the verticality.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="switch-ball-directions-but-only-the-y-axis-block-314" href="#switch-ball-directions-but-only-the-y-axis-block-314">Switch ball directions but only the Y axis</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wBallNextDirection]
    xor a, 1 &lt;&lt; F_VERTICAL
    set F_APPLY_VERTICAL, a
    ld [wBallNextDirection], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#determine-ball-s-next-movement-block-272" title="Determine ball's next movement">1</a> </small></p></div>




<h2>5. Giving players some points<a id="s2:4"></a></h2>


<p>One way I can give points to the players is by doing it directly when the ball updates its position. So, I&rsquo;ll modify the ball physics code from before to make it call (or rather&mdash;jump to) a scoring function when it hits the edges of the screen.</p>

<p>A point is earned for the left player when the ball goes out on the right half of the screen.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-to-the-right-block-316" href="#move-the-ball-to-the-right-block-316">Move the ball to the right</a></em></strong> <a href="#move-the-ball-to-the-right-block-278">+=</a></span>
<pre class="prettyprint"><code class="">; if new X &gt;= (160+8), score one point towards the left player
    ld a, [hl]
    cp 160+8
    jp nc, ScorePointsAndReset
</code></pre>
</div>


<p>Likewise, a point earned for the right player when the ball goes out on the left half.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-ball-to-the-left-block-318" href="#move-the-ball-to-the-left-block-318">Move the ball to the left</a></em></strong> <a href="#move-the-ball-to-the-left-block-280">:=</a></span>
<pre class="prettyprint"><code class="">; forcibly clear flags, at this point A=0
    and a  ; clear carry
    rla    ; clear zero

    dec [hl]
    
; if new X &lt; 0, score one point towards the right player
; set carry flag to mark the right player earns 1 point
    jr nz, .apply_ball_y
    scf
    jp ScorePointsAndReset
</code></pre>
</div>


<p>I&rsquo;ll use the carry flag to differentiate between the two when going to scoring.</p>

<h3>The scoring function</h3>

<p>In addition to giving a player 1 point, I want to make it reset the game state so that the next round can begin cleanly.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="score-points-and-reset-the-game-state-block-320" href="#score-points-and-reset-the-game-state-block-320">Score points and reset the game state</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Score points and reset the game states.
;; 
;; @param Carry   if set, give 1 point to the right player.
;;                otherwise, give 1 point to the left player.
;;--
ScorePointsAndReset::
<em class="block-link nocode"><a href="#determine-if-the-score-to-be-given-is-to-the-left-player-or-the-right-block-326">@{Determine if the score to be given is to the left player or the right}</a></em>
<em class="block-link nocode"><a href="#reset-the-game-state-block-328">@{Reset the game state}</a></em>

.give_point
<em class="block-link nocode"><a href="#score-points-to-the-appropriate-player-block-330">@{Score points to the appropriate player}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-336" title="Helper functions">1</a> </small></p></div>


<p>I also want to make it so that the game switches who &ldquo;serves&rdquo; the ball. This value will be copied onto <code>wBallNextDirection</code> later.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-322" href="#constants-block-322">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">; wWhichServe values (using wBallNextDirection)
RIGHT_PLAYER_SERVES equ 0
LEFT_PLAYER_SERVES  equ 1 &lt;&lt; F_HORIZONTAL
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-324" href="#wram-definitions-block-324">WRAM definitions</a></em></strong> <a href="part2.html#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">wWhichServe:: db
</code></pre>
</div>


<p>The target is determined by HL, which is set to the left player&rsquo;s score&rsquo;s address initially. When carry is set, it will be overwritten to that of the right player&rsquo;s. I&rsquo;ll also want to use this section to set the serving player to that opposite of the winner.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-if-the-score-to-be-given-is-to-the-left-player-or-the-right-block-326" href="#determine-if-the-score-to-be-given-is-to-the-left-player-or-the-right-block-326">Determine if the score to be given is to the left player or the right</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, wLeftScore
    jr nc, .left_player_won

; right player won
    ld hl, wRightScore
    ld a, LEFT_PLAYER_SERVES
    ld [wWhichServe], a
    call .give_point
    jr .got_player

.left_player_won
    ld a, RIGHT_PLAYER_SERVES
    ld [wWhichServe], a
    call .give_point

.got_player
</code></pre>
<p class="block-usages"><small>Used by <a href="#score-points-and-reset-the-game-state-block-320" title="Score points and reset the game state">1</a> </small></p></div>


<p>And then, reset the game for a new round.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-game-state-block-328" href="#reset-the-game-state-block-328">Reset the game state</a></em></strong></span>
<pre class="prettyprint"><code class="">    call ResetGame
    jp GameLoop
</code></pre>
<p class="block-usages"><small>Used by <a href="#score-points-and-reset-the-game-state-block-320" title="Score points and reset the game state">1</a> </small></p></div>


<p>Since I&rsquo;m using BCD for scoring, I&rsquo;ll be using the decimal adjust (<code>daa</code>) instruction. It relies on the correct flags being set in order to perform the adjustments, so I&rsquo;m gonna have to reset the flags prior to incrementing it.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="score-points-to-the-appropriate-player-block-330" href="#score-points-to-the-appropriate-player-block-330">Score points to the appropriate player</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [hl]
    and a  ; reset flags
    inc a
    daa
    ld [hl], a
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#score-points-and-reset-the-game-state-block-320" title="Score points and reset the game state">1</a> </small></p></div>


<h3>Split off game resetting function</h3>

<p>As a consequence, the game initialization routine will have to be split off into its own function. This time, <code>wWhichServe</code> is considered here, and <code>wDeltaYFromPaddle</code> will also be reset.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="resetgame-block-332" href="#resetgame-block-332">ResetGame</a></em></strong></span>
<pre class="prettyprint"><code class="">ResetGame::
    ld a, PADDLES_STARTING_Y
    ld [wLeftPaddleY], a
    ld [wRightPaddleY], a
    
    ld a, BALL_STARTING_X
    ld [wBallX], a
    
    ld a, BALL_STARTING_Y
    ld [wBallY], a
    
    ld a, [wWhichServe]
    ld [wBallNextDirection], a
    
    xor a
    ld [wDeltaYFromPaddle], a
    
    call SetupLeftPaddle
    call SetupRightPaddle
    jp SetupBall
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-336" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sprites-and-variables-block-334" href="#set-up-sprites-and-variables-block-334">Set up sprites and variables</a></em></strong> <a href="part2.html#set-up-sprites-and-variables-block-147">:=</a></span>
<pre class="prettyprint"><code class="">    call ResetGame
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-336" href="#helper-functions-block-336">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#score-points-and-reset-the-game-state-block-320">@{Score points and reset the game state}</a></em>
<em class="block-link nocode"><a href="#resetgame-block-332">@{ResetGame}</a></em>
</code></pre>
</div>


<h2>6. The simplest possible AI<a id="s2:5"></a></h2>


<p>As <a href="#handle-the-right-paddle-block-228">mentioned earlier</a>, I reserved the right paddle handler routine to be controlled as the CPU opponent. I&rsquo;m gonna attempt to make its &ldquo;thinking&rdquo; routine.</p>

<p>First, I&rsquo;ll make a very simple one that just copies the position of the ball.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-the-right-paddle-block-338" href="#handle-the-right-paddle-block-338">Handle the right paddle</a></em></strong> <a href="#handle-the-right-paddle-block-256">:=</a></span>
<pre class="prettyprint"><code class="">.right_paddle
<em class="block-link nocode"><a href="#load-the-ball-s-current-y-position-block-340">@{Load the ball's current Y position}</a></em>
<em class="block-link nocode"><a href="#set-position-boundaries-block-342">@{Set position boundaries}</a></em>
<em class="block-link nocode"><a href="#set-right-paddle-s-y-position-block-344">@{Set right paddle's Y position}</a></em>
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="load-the-ball-s-current-y-position-block-340" href="#load-the-ball-s-current-y-position-block-340">Load the ball's current Y position</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wBallY]
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-338" title="Handle the right paddle">1</a> </small></p></div>


<p>I also apply the boundary checks here.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-position-boundaries-block-342" href="#set-position-boundaries-block-342">Set position boundaries</a></em></strong></span>
<pre class="prettyprint"><code class="">; assumes A is the calculated paddle position
    cp PADDLES_UPPER_BOUNDARY
    jr c, .limit_upper
    cp PADDLES_LOWER_BOUNDARY
    jr nc, .limit_lower
    jr .set_paddle_y
.limit_upper
    ld a, PADDLES_UPPER_BOUNDARY
    jr .set_paddle_y
.limit_lower
    ld a, PADDLES_LOWER_BOUNDARY
    ;jr .set_paddle_y
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-338" title="Handle the right paddle">1</a> <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">2</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-right-paddle-s-y-position-block-344" href="#set-right-paddle-s-y-position-block-344">Set right paddle's Y position</a></em></strong></span>
<pre class="prettyprint"><code class="">.set_paddle_y
    ld [wRightPaddleY], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-338" title="Handle the right paddle">1</a> <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">2</a> </small></p></div>


<p>What this results in is a pretty unfair AI that <em>always</em> catches the ball. Let&rsquo;s just say you&rsquo;ll be having a hard time beating it.</p>

<p><figure>
<video controls width="300">
    <source type="video/mp4" src="../figures/s-2023-04-20_09.44.25.mp4">
    <a href="../figures/s-2023-04-20_09.44.25.mp4">Video file</a>
</video>
</figure></p>

<h3>Delayed AI</h3>

<p>Let&rsquo;s make it a bit fairer. How about having the paddle move only after a short while? Say, it should wait a couple of frames until it&rsquo;s able to move the paddle.</p>

<p>I can do this by setting a single delay and then having a timer that decrements on every step. Then when the timer hits zero, the paddle can move and the timer can be reset again. I&rsquo;m gonna need two extra variables:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-346" href="#wram-definitions-block-346">WRAM definitions</a></em></strong> <a href="part2.html#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">wAIMovementDelay:: db
wAISetDelay:: db
</code></pre>
</div>


<p>Next, the delay constant.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-348" href="#constants-block-348">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class="">RIGHT_PADDLE_DELAY equ 1
</code></pre>
</div>


<p>I set this up in the intializer function.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sprites-and-variables-block-350" href="#set-up-sprites-and-variables-block-350">Set up sprites and variables</a></em></strong> <a href="part2.html#set-up-sprites-and-variables-block-147">+=</a></span>
<pre class="prettyprint"><code class="">    ld a, RIGHT_PADDLE_DELAY
    ld [wAISetDelay], a
</code></pre>
</div>


<p>Next, let&rsquo;s rework the right paddle function.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-the-right-paddle-block-352" href="#handle-the-right-paddle-block-352">Handle the right paddle</a></em></strong> <a href="#handle-the-right-paddle-block-256">:=</a></span>
<pre class="prettyprint"><code class="">.right_paddle
<em class="block-link nocode"><a href="#determine-if-the-right-paddle-can-move-or-not-block-354">@{Determine if the right paddle can move or not}</a></em>
<em class="block-link nocode"><a href="#only-decrement-the-timer-block-356">@{Only decrement the timer}</a></em>

.move_paddle
<em class="block-link nocode"><a href="#reset-the-timer-block-358">@{Reset the timer}</a></em>
<em class="block-link nocode"><a href="#move-the-right-paddle-relative-to-the-ball-block-360">@{Move the right paddle relative to the ball}</a></em>

.check_boundaries
<em class="block-link nocode"><a href="#set-position-boundaries-block-342">@{Set position boundaries}</a></em>
<em class="block-link nocode"><a href="#set-right-paddle-s-y-position-block-344">@{Set right paddle's Y position}</a></em>

.skip_right_paddle
</code></pre>
</div>


<p>First up, I&rsquo;ll check the timer if it&rsquo;s run out. If so, I can try moving the right paddle.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-if-the-right-paddle-can-move-or-not-block-354" href="#determine-if-the-right-paddle-can-move-or-not-block-354">Determine if the right paddle can move or not</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wAIMovementDelay]
    and a
    jr z, .move_paddle
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">1</a> </small></p></div>


<p>Otherwise, I&rsquo;ll just decrement the timer and skip trying to move it.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="only-decrement-the-timer-block-356" href="#only-decrement-the-timer-block-356">Only decrement the timer</a></em></strong></span>
<pre class="prettyprint"><code class="">    dec a
    ld [wAIMovementDelay], a
    jr .skip_right_paddle
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">1</a> </small></p></div>


<p>If the timer <em>did</em> reach zero, it&rsquo;ll be reset to its initial value.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-timer-block-358" href="#reset-the-timer-block-358">Reset the timer</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, [wAISetDelay]
    ld [wAIMovementDelay], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">1</a> </small></p></div>


<p>And then move the paddle up or down depending on whether the ball is above the paddle or below the paddle.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="move-the-right-paddle-relative-to-the-ball-block-360" href="#move-the-right-paddle-relative-to-the-ball-block-360">Move the right paddle relative to the ball</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, wRightPaddleY
    ld a, [wBallY]
    cp [hl]
    ld a, [hl]

; if paddle is lower than ball, move up
    jr c, .move_up

; else, move down
    inc a
    jr .check_boundaries

.move_up
    dec a
    ; jr .check_boundaries
</code></pre>
<p class="block-usages"><small>Used by <a href="#handle-the-right-paddle-block-352" title="Handle the right paddle">1</a> </small></p></div>


<p>And there you have it, an AI you can beat. Well, there are quirks to be sorted out here, but it&rsquo;s alright I guess, even though this is more A than I.</p>

<h2>7. First proof of concept<a id="s2:6"></a></h2>


<p>With that, I&rsquo;ve got the first version that&rsquo;s &ldquo;playable&rdquo;. Kinda. For the most part, the basic parts of the game works as expected:</p>

<ul>
<li>Controlling the left paddle with the d-pad</li>
<li>Scoring and beginning a new round</li>
<li>Ball physics</li>
<li>CPU player moving the right paddle</li>
</ul>


<p><figure>
<video controls width="300">
    <source type="video/mp4" src="../figures/s-2023-04-20_10.01.31.mp4">
    <a href="../figures/s-2023-04-20_10.01.31.mp4">Video file</a>
</video>
</figure></p>
</body>
</html>
