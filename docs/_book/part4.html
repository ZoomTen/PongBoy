<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Using game modes</title>
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<link rel="stylesheet" href="styles/prettify-theme.css">
<script defer src="google-code-prettify/prettify.js"></script>
<script defer src="google-code-prettify/run_prettify.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>

<!-- Generated by srcweave https://github.com/justinmeiners/srcweave -->


<h1>Using game modes<a id="c3"></a></h1>




<h2>1. Set up for game mode support<a id="s3:0"></a></h2>


<p>So thus far the game loop only accomodates for only one activity: the main game. Maybe other features or screens are to be added, which&mdash;with this kind of setup&mdash;might make a mess out of the codebase.</p>

<p><figure>
<img src="../figures/boring-flowchart.svg">
</figure></p>

<p>Many games have a &ldquo;game mode&rdquo; (or &ldquo;game state&rdquo;) pattern for its main loop. Essentially, what this means is that every mode in the game has its own dedicated loop subroutine that processes only the logic relevant to that mode, and it&rsquo;s the main loop&rsquo;s job to execute the correct one for each game mode.</p>

<p>I think it&rsquo;s a good idea to start implementing that now, since I have a working game and thus a known &ldquo;good&rdquo; state.</p>

<p>The pattern basically works like this:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-loop-code-block-363" href="#game-loop-code-block-363">Game loop code</a></em></strong> <a href="part3.html#game-loop-code-block-188">:=</a></span>
<pre class="prettyprint"><code class="">GameLoop::
<em class="block-link nocode"><a href="#determine-which-game-mode-is-to-be-run-and-perform-initializations-block-367">@{Determine which game mode is to be run and perform initializations}</a></em>
<em class="block-link nocode"><a href="#perform-game-mode-loop-block-375">@{Perform game mode loop}</a></em>
<em class="block-link nocode" title="part3.md"><a href="part3.html#wait-one-frame-block-190">@{Wait one frame}</a></em>
    jp GameLoop
</code></pre>
</div>


<p>I&rsquo;ll want to keep track of the current game mode, and also the previous game mode, so that my routine knows when a new one is loaded. Gonna put them in HRAM for quick access.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="hram-definitions-block-365" href="#hram-definitions-block-365">HRAM definitions</a></em></strong> <a href="part2.html#hram-definitions-block-79">+=</a></span>
<pre class="prettyprint"><code class="">hGameMode:: db
hOldGameMode:: db
</code></pre>
</div>


<p>Not only would I want every game mode have its own loop routine, but also an initialization routine that runs only when the game mode is switched to. For both, I&rsquo;ll be using a jumptable with the pointers to each routine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="determine-which-game-mode-is-to-be-run-and-perform-initializations-block-367" href="#determine-which-game-mode-is-to-be-run-and-perform-initializations-block-367">Determine which game mode is to be run and perform initializations</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, hOldGameMode
    ldh a, [hGameMode]
    cp [hl]
    jr z, .skip_init
    
    ld hl, GMInitJumptable
    call GotoJumptableEntry
    
    ldh a, [hGameMode]  ; reload game mode
    ldh [hOldGameMode], a  ; replace old game mode
.skip_init
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-363" title="Game loop code">1</a> </small></p></div>


<p>And here&rsquo;s the function that will execute the appropriate routine. The A register determines which entry is to be selected, and HL must be advanced accordingly. Since the jumptable entries are simple pointers, they&rsquo;ll be two bytes each&mdash;so HL + 2 &times; A.</p>

<p>I&rsquo;ll retrieve the value of HL (the entry itself) <em>from</em> where HL is pointing to (the address of the entry), and then jump there.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gotojumptableentry-block-369" href="#gotojumptableentry-block-369">GotoJumptableEntry</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Go to jumptable entry
;; 
;; @param HL  Jumptable address containing pointers
;; @param A   Entry number
;; @clobber DE
;;--
GotoJumptableEntry::
    ld e, a
    ld d, 0
    add hl, de
    add hl, de
    ld a, [hl+]
    ld h, [hl]
    ld l, a
    jp [hl]
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-371" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-371" href="#helper-functions-block-371">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#gotojumptableentry-block-369">@{GotoJumptableEntry}</a></em>
</code></pre>
</div>


<p>I&rsquo;ll reserve the init routines jumptable here. (Game mode related stuff have the &ldquo;GM&rdquo; prefix, for &ldquo;Game Mode&rdquo;)</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-loop-code-block-373" href="#game-loop-code-block-373">Game loop code</a></em></strong> <a href="part3.html#game-loop-code-block-188">+=</a></span>
<pre class="prettyprint"><code class="">GMInitJumptable::
<em class="block-link nocode"><a href="#pointers-to-game-mode-initialization-routines-block-393">@{Pointers to game mode initialization routines}</a></em>
</code></pre>
</div>


<p>Since I copied <code>hGameMode</code> to <code>hOldGameMode</code>, A contains <code>hGameMode</code>. So, executing the loop is simply:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="perform-game-mode-loop-block-375" href="#perform-game-mode-loop-block-375">Perform game mode loop</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, GMLoopJumptable
    call GotoJumptableEntry
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-363" title="Game loop code">1</a> </small></p></div>


<p>And the associated jumptable:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-loop-code-block-377" href="#game-loop-code-block-377">Game loop code</a></em></strong> <a href="part3.html#game-loop-code-block-188">+=</a></span>
<pre class="prettyprint"><code class="">GMLoopJumptable::
<em class="block-link nocode"><a href="#pointers-to-game-mode-loop-routines-block-395">@{Pointers to game mode loop routines}</a></em>
</code></pre>
</div>


<p>Last, I reserve some slots for the actual init and loop routines in the main program code:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="main-program-block-379" href="#main-program-block-379">Main program</a></em></strong> <a href="part1.html#main-program-block-50">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#game-mode-initialization-code-block-387">@{Game mode initialization code}</a></em>
<em class="block-link nocode"><a href="#game-mode-loop-code-block-391">@{Game mode loop code}</a></em>
</code></pre>
</div>




<h2>2. Adapting my code for the new system<a id="s3:1"></a></h2>


<p>Let&rsquo;s adapt the main loop I have now into a &ldquo;self-contained&rdquo; game mode. First I&rsquo;ll reserve some constants for the game mode identifier.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="constants-block-381" href="#constants-block-381">Constants</a></em></strong> <a href="part2.html#constants-block-131">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#game-mode-constants-block-383">@{Game mode constants}</a></em>
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-constants-block-383" href="#game-mode-constants-block-383">Game mode constants</a></em></strong></span>
<pre class="prettyprint"><code class="">GM_GAME equ 0
</code></pre>
<p class="block-usages"><small>Used by <a href="#constants-block-381" title="Constants">1</a> </small></p></div>


<p>Next, I&rsquo;ll move the portion of the existing init code into its own function.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_game-init-code-block-385" href="#gm_game-init-code-block-385">GM_Game init code</a></em></strong></span>
<pre class="prettyprint"><code class="">GM_Game_init::
    call DisableLCD
<em class="block-link nocode" title="part2.md"><a href="part2.html#set-up-the-game-graphics-block-121">@{Set up the game graphics}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#set-up-sprites-and-variables-block-147">@{Set up sprites and variables}</a></em>
    jp EnableLCD
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-mode-initialization-code-block-387" title="Game mode initialization code">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-initialization-code-block-387" href="#game-mode-initialization-code-block-387">Game mode initialization code</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#gm_game-init-code-block-385">@{GM_Game init code}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#main-program-block-379" title="Main program">1</a> </small></p></div>


<p>Likewise with the existing loop code.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_game-loop-code-block-389" href="#gm_game-loop-code-block-389">GM_Game loop code</a></em></strong></span>
<pre class="prettyprint"><code class="">GM_Game_loop::
<em class="block-link nocode" title="part3.md"><a href="part3.html#handle-joypad-input-block-222">@{Handle joypad input}</a></em>
<em class="block-link nocode" title="part3.md"><a href="part3.html#handle-ball-physics-block-262">@{Handle ball physics}</a></em>
<em class="block-link nocode" title="part3.md"><a href="part3.html#update-screen-block-202">@{Update screen}</a></em>
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-mode-loop-code-block-391" title="Game mode loop code">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-loop-code-block-391" href="#game-mode-loop-code-block-391">Game mode loop code</a></em></strong></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#gm_game-loop-code-block-389">@{GM_Game loop code}</a></em>
</code></pre>
<p class="block-usages"><small>Used by <a href="#main-program-block-379" title="Main program">1</a> </small></p></div>


<p>I&rsquo;ll add the addresses of both routines to their respective jumptables.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="pointers-to-game-mode-initialization-routines-block-393" href="#pointers-to-game-mode-initialization-routines-block-393">Pointers to game mode initialization routines</a></em></strong></span>
<pre class="prettyprint"><code class="">    dw GM_Game_init
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-373" title="Game loop code">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="pointers-to-game-mode-loop-routines-block-395" href="#pointers-to-game-mode-loop-routines-block-395">Pointers to game mode loop routines</a></em></strong></span>
<pre class="prettyprint"><code class="">    dw GM_Game_loop
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-loop-code-block-377" title="Game loop code">1</a> </small></p></div>


<h3>Fix the program init</h3>

<p>Next, I&rsquo;ll have to change the initialization routine to use the new system, by setting the initial game mode.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="initialization-code-block-397" href="#initialization-code-block-397">Initialization code</a></em></strong> <a href="part2.html#initialization-code-block-75">:=</a></span>
<pre class="prettyprint"><code class="">Init::
<em class="block-link nocode" title="part2.md"><a href="part2.html#disable-interrupts-block-77">@{Disable interrupts}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#save-the-game-boy-type-block-81">@{Save the Game Boy type}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#turn-off-the-screen-block-97">@{Turn off the screen}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#clear-ram-and-place-the-stack-pointer-block-83">@{Clear RAM and place the stack pointer}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#reset-audio-block-105">@{Reset audio}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#reset-the-screen-block-99">@{Reset the screen}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#copy-hram-dma-code-block-117">@{Copy HRAM DMA code}</a></em>

; +++
<em class="block-link nocode"><a href="#set-the-initial-game-mode-block-399">@{Set the initial game mode}</a></em>
; +++

<em class="block-link nocode" title="part2.md"><a href="part2.html#turn-on-screen-block-183">@{Turn on screen}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#enable-the-interrupts-again-block-185">@{Enable the interrupts again}</a></em>
</code></pre>
</div>


<p>I set the initial <code>hOldGameMode</code> to force the game to fire the initialization routine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-the-initial-game-mode-block-399" href="#set-the-initial-game-mode-block-399">Set the initial game mode</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld a, $ff
    ldh [hOldGameMode], a
    xor a  ; ld a, GM_GAME
    ldh [hGameMode], a
</code></pre>
<p class="block-usages"><small>Used by <a href="#initialization-code-block-397" title="Initialization code">1</a> </small></p></div>


<p>I&rsquo;ll also do this when resetting the game state from the scoring routine.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="reset-the-game-state-block-401" href="#reset-the-game-state-block-401">Reset the game state</a></em></strong> <a href="part3.html#reset-the-game-state-block-328">:=</a></span>
<pre class="prettyprint"><code class="">; force a reinitialization
    ld a, $ff
    ldh [hOldGameMode], a
    jp GameLoop
</code></pre>
</div>


<p>After this, the game should look and play identical as before. The changes are really just under-the-hood stuff that&rsquo;ll make it more convenient to me to add more screens to the game.</p>

<h3>Fix score updating</h3>

<p>This is kind of a quick hack (out of several quick hacks done so far, really) so that the score doesn&rsquo;t update all the time, only when asked to.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="wram-definitions-block-403" href="#wram-definitions-block-403">WRAM definitions</a></em></strong> <a href="part2.html#wram-definitions-block-89">+=</a></span>
<pre class="prettyprint"><code class="">wShouldUpdateScore:: db
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="update-the-score-display-block-405" href="#update-the-score-display-block-405">Update the score display</a></em></strong> <a href="part3.html#update-the-score-display-block-210">:=</a></span>
<pre class="prettyprint"><code class="">; +++
    ld a, [wShouldUpdateScore]
    and a
    jr z, .skip_score_update
; +++

    ld a, [wLeftScore]
    ld hl, LEFT_SCORE_VRAM_START
    call ShowScore
    
    ld a, [wRightScore]
    ld hl, RIGHT_SCORE_VRAM_START
    call ShowScore
; +++
.skip_score_update
; +++
</code></pre>
</div>


<p>And I set it to be enabled when the game first boots up.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-sprites-and-variables-block-407" href="#set-up-sprites-and-variables-block-407">Set up sprites and variables</a></em></strong> <a href="part2.html#set-up-sprites-and-variables-block-147">+=</a></span>
<pre class="prettyprint"><code class="">    ld a, 1
    ld [wShouldUpdateScore], a
</code></pre>
</div>


<h2>3. Adding a title screen<a id="s3:2"></a></h2>


<p><figure>
<img src="../figures/game-mode.svg">
</figure></p>

<p>Well, it&rsquo;s time to use this new system to add a new screen: the title screen. At the moment, it really should just do nothing but say &ldquo;Press Start&rdquo;, and then kicks you into straight into the game. Although from the player&rsquo;s perspective it comes before the gameplay, internally I&rsquo;m going to define this mode <em>after</em> the gameplay mode.</p>

<p>Because its only job is to show the game&rsquo;s title and wait for joypad input, the code is gonna be really simple:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_title-init-code-block-409" href="#gm_title-init-code-block-409">GM_Title init code</a></em></strong></span>
<pre class="prettyprint"><code class="">GM_Title_init::
    call DisableLCD
<em class="block-link nocode"><a href="#set-up-the-title-screen-graphics-block-413">@{Set up the title screen graphics}</a></em>
    jp EnableLCD
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-mode-initialization-code-block-423" title="Game mode initialization code">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_title-loop-code-block-411" href="#gm_title-loop-code-block-411">GM_Title loop code</a></em></strong></span>
<pre class="prettyprint"><code class="">GM_Title_loop::
<em class="block-link nocode"><a href="#handle-title-screen-joypad-input-block-419">@{Handle title screen joypad input}</a></em>
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#game-mode-loop-code-block-425" title="Game mode loop code">1</a> </small></p></div>


<h3>Initialization</h3>

<p>Of course, the initialization is simply just copying the necessary graphics data to VRAM&hellip;</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-up-the-title-screen-graphics-block-413" href="#set-up-the-title-screen-graphics-block-413">Set up the title screen graphics</a></em></strong></span>
<pre class="prettyprint"><code class="">    ld hl, vChars0
    ld de, TitleScreenGFX
    ld bc, TitleScreenGFX_END - TitleScreenGFX
    call CopyMem16
    
    ld hl, vBGMap0
    ld de, TitleScreenMAP
    ld bc, TitleScreenMAP_END - TitleScreenMAP
    call CopyMem16
</code></pre>
<p class="block-usages"><small>Used by <a href="#gm_title-init-code-block-409" title="GM_Title init code">1</a> <a href="#gm_title-init-code-block-447" title="GM_Title init code">2</a> </small></p></div>


<p>And both the tileset and the tilemap are generated off of a single png&hellip;</p>

<p><figure>
<img class="pixelated" alt="Game graphics" src="../src/gfx/title-screen.png">
<figcaption>Title screen graphics. Yes, I just made an entire 256&times;256 px tile map for only one screenful of graphics, &lsquo;cuz I&rsquo;m just lazy.</figcaption>
</figure></p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="miscellaneous-data-block-415" href="#miscellaneous-data-block-415">Miscellaneous data</a></em></strong> <a href="part2.html#miscellaneous-data-block-123">+=</a></span>
<pre class="prettyprint"><code class="">TitleScreenGFX::
    incbin "gfx/title-screen.2bpp"
TitleScreenGFX_END::
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="miscellaneous-data-block-417" href="#miscellaneous-data-block-417">Miscellaneous data</a></em></strong> <a href="part2.html#miscellaneous-data-block-123">+=</a></span>
<pre class="prettyprint"><code class="">TitleScreenMAP::
    incbin "gfx/title-screen.map"
TitleScreenMAP_END::
</code></pre>
</div>


<h3>Loop</h3>

<p>The loop is just checking whether or not the START button is pressed, with an early <code>ret</code> if not:</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-title-screen-joypad-input-block-419" href="#handle-title-screen-joypad-input-block-419">Handle title screen joypad input</a></em></strong></span>
<pre class="prettyprint"><code class="">    call ReadJoypad
    ldh a, [hInput]
    bit BUTTONF_START, a
    ret z
</code></pre>
<p class="block-usages"><small>Used by <a href="#gm_title-loop-code-block-411" title="GM_Title loop code">1</a> </small></p></div>


<p>But if it <em>is</em> pressed, it&rsquo;ll jump to the game.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="handle-title-screen-joypad-input-block-421" href="#handle-title-screen-joypad-input-block-421">Handle title screen joypad input</a></em></strong> <a href="#handle-title-screen-joypad-input-block-419">+=</a></span>
<pre class="prettyprint"><code class="">    xor a  ; ld a, GM_GAME
    ldh [hGameMode], a
    ret
</code></pre>
</div>


<h3>Adding it to the ROM</h3>

<p>Let&rsquo;s add all of the stuff above into the ROM.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-initialization-code-block-423" href="#game-mode-initialization-code-block-423">Game mode initialization code</a></em></strong> <a href="#game-mode-initialization-code-block-387">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#gm_title-init-code-block-409">@{GM_Title init code}</a></em>
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-loop-code-block-425" href="#game-mode-loop-code-block-425">Game mode loop code</a></em></strong> <a href="#game-mode-loop-code-block-391">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#gm_title-loop-code-block-411">@{GM_Title loop code}</a></em>
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="pointers-to-game-mode-initialization-routines-block-427" href="#pointers-to-game-mode-initialization-routines-block-427">Pointers to game mode initialization routines</a></em></strong> <a href="#pointers-to-game-mode-initialization-routines-block-393">+=</a></span>
<pre class="prettyprint"><code class="">    dw GM_Title_init
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="pointers-to-game-mode-loop-routines-block-429" href="#pointers-to-game-mode-loop-routines-block-429">Pointers to game mode loop routines</a></em></strong> <a href="#pointers-to-game-mode-loop-routines-block-395">+=</a></span>
<pre class="prettyprint"><code class="">    dw GM_Title_loop
</code></pre>
</div>




<h2>4. Booting up to the title screen<a id="s3:3"></a></h2>


<p>I&rsquo;ll change the starting game mode here.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="game-mode-constants-block-431" href="#game-mode-constants-block-431">Game mode constants</a></em></strong> <a href="#game-mode-constants-block-383">+=</a></span>
<pre class="prettyprint"><code class="">GM_TITLE equ 1
</code></pre>
</div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="set-the-initial-game-mode-block-433" href="#set-the-initial-game-mode-block-433">Set the initial game mode</a></em></strong> <a href="#set-the-initial-game-mode-block-399">:=</a></span>
<pre class="prettyprint"><code class="">    ld a, $ff
    ldh [hOldGameMode], a
    ld a, GM_TITLE ; +++
    ldh [hGameMode], a
</code></pre>
</div>




<h2>5. Fading the screen in and out<a id="s3:4"></a></h2>


<p>I want to add a nice fade in/out effect to the game. Originally I was gonna be fancy and make a &ldquo;unique&rdquo; fading routing that switches between phases every frame, but I think I&rsquo;ll just be making a simple one.</p>

<p>The idea here is change the palettes every odd frame or so:</p>

<p><figure>
<img src="../figures/fade1.svg">
<figcaption>A sensible fading routine</figcaption>
</figure></p>

<p>I&rsquo;ll want to write a routine to delay C amount of frames, calling <code>DelayFrame</code> and decrementing C each time until C is 0.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="delayframes-block-435" href="#delayframes-block-435">DelayFrames</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; @param  C  amount of frames to wait
;; @return C  0
;;--
DelayFrames::
.loop
    call DelayFrame
    dec c
    jr nz, .loop
    ret
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-437" title="Helper functions">1</a> </small></p></div>


<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-437" href="#helper-functions-block-437">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#delayframes-block-435">@{DelayFrames}</a></em>
</code></pre>
</div>


<p>Next up, a shortcut to apply the palette data and wait 2 frames using the above function. If doing 2 frames, <code>call DelayFrame; jp DelayFrame</code> may suffice, but for some reason I want the delay between phases to be configurable.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="applypalettewait-block-439" href="#applypalettewait-block-439">ApplyPaletteWait</a></em></strong></span>
<pre class="prettyprint"><code class="">;;--
;; Applies palette A and then wait 2 frames.
;; 
;; @param  A  palette data
;;--
ApplyPaletteWait::
    ldh [rBGP], a
    ldh [rOBP0], a
    ldh [rOBP1], a
    ld c, 2 ; frames to wait between phases
    jp DelayFrames
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-445" title="Helper functions">1</a> </small></p></div>


<p>Then, the actual routines. I&rsquo;ll just be writing palette data and then a short delay between writes.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="fadeout-block-441" href="#fadeout-block-441">FadeOut</a></em></strong></span>
<pre class="prettyprint"><code class="">FadeOut::
    ld a, %11100100
    call ApplyPaletteWait
    ld a, %10010000
    call ApplyPaletteWait
    ld a, %01000000
    call ApplyPaletteWait
    xor a  ; %00000000
    jp ApplyPaletteWait
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-445" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="fadein-block-443" href="#fadein-block-443">FadeIn</a></em></strong></span>
<pre class="prettyprint"><code class="">FadeIn::
    xor a  ; %00000000
    call ApplyPaletteWait
    ld a, %01000000
    call ApplyPaletteWait
    ld a, %10010000
    call ApplyPaletteWait
    ld a, %11100100
    jp ApplyPaletteWait
</code></pre>
<p class="block-usages"><small>Used by <a href="#helper-functions-block-445" title="Helper functions">1</a> </small></p></div>




<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="helper-functions-block-445" href="#helper-functions-block-445">Helper functions</a></em></strong> <a href="part1.html#helper-functions-block-54">+=</a></span>
<pre class="prettyprint"><code class=""><em class="block-link nocode"><a href="#fadeout-block-441">@{FadeOut}</a></em>
<em class="block-link nocode"><a href="#fadein-block-443">@{FadeIn}</a></em>
<em class="block-link nocode"><a href="#applypalettewait-block-439">@{ApplyPaletteWait}</a></em>
</code></pre>
</div>


<h3>Applying the fade effects</h3>

<p>First I&rsquo;ll apply the fade-in effect to the title screen. I replaced the <code>jp EnableLCD</code> instruction with the <code>call</code> equivalent, and then jumping to <code>FadeIn</code>.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_title-init-code-block-447" href="#gm_title-init-code-block-447">GM_Title init code</a></em></strong> <a href="#gm_title-init-code-block-409">:=</a></span>
<pre class="prettyprint"><code class="">GM_Title_init::
    call DisableLCD
<em class="block-link nocode"><a href="#set-up-the-title-screen-graphics-block-413">@{Set up the title screen graphics}</a></em>
    call EnableLCD
    jp FadeIn
</code></pre>
</div>


<p>For the gameplay entry, I decided to use <code>DelayFrames</code> to wait some amount of time before fading out and resetting the game state.</p>

<div class="code-block">
<span class="block-header">
<strong class="block-title"><em><a id="gm_game-init-code-block-449" href="#gm_game-init-code-block-449">GM_Game init code</a></em></strong> <a href="#gm_game-init-code-block-385">:=</a></span>
<pre class="prettyprint"><code class="">GM_Game_init::
    ld c, 32
    call DelayFrames
    call FadeOut
    call DisableLCD
<em class="block-link nocode" title="part2.md"><a href="part2.html#set-up-the-game-graphics-block-121">@{Set up the game graphics}</a></em>
<em class="block-link nocode" title="part2.md"><a href="part2.html#set-up-sprites-and-variables-block-147">@{Set up sprites and variables}</a></em>
    call EnableLCD
    jp FadeIn
</code></pre>
</div>

</body>
</html>
